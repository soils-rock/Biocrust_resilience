---
title: >
  "`r params$experiment` Study <br><span style='font-size:70%;'>Biocrust layers removed and recovering biocrusts monitored</span>"
author: "Dr. Brian Scott"
date: "`r format(Sys.time(), '%A, %B %d, %Y')`"
output:
  html_document:
    toc: yes
    toc_float: yes
    toc_depth: 2
    theme: united
  word_document:
    toc: yes
    toc_depth: '2'
  pdf_document:
    toc: yes
    toc_depth: '2'
params:
  experiment: Biocrust Resilience
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#setwd("~/ASU Dropbox/Brian Scott/ASU/R/Biocrust Recovery")
```
## Required packages:
```{r packages, message=FALSE}
#library(ANCOMBC)
library(forcats)
library(ggtext)
#install.packages("BiocManager")
#BiocManager::install("edgeR")
library(edgeR)
library(readxl)
library(stringr)
library(ggrepel)
#BiocManager::install("phyloseq")
library(phyloseq)
library(vegan)
library(flextable)
library(officer)
#install.packages("devtools")
#devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")
library(pairwiseAdonis)
library(patchwork)
library(scales)
library(ggplot2)
library(tidyverse)  
library(dplyr) 
library(RVAideMemoire)
#install.packages("multcomp")
library(multcomp)
```
## Import raw data
### Metadata for lab study
```{r message=FALSE}

metadata <- read_csv("metadata.csv") |> 
  filter(!str_detect(sampleid, "EICP")) |>
  filter(!str_detect(sampleid, "YR2")) |>
  mutate(Location = str_replace(Location, "Lic", "LC")) |>
  mutate(sampleid = str_replace(sampleid, "LIC", "LC")) |>
  mutate(
    Succession = recode(Succession, "First" = "Light", "Second" = "Dark"),
    Succession = case_when(
      Location == "E25" ~ "Elevated",
      Location == "E31" ~ "Elevated",
      Location == "LC" ~ "Dark",
      TRUE ~ Succession  # Retain original Succession values for other locations
    )
  ) |>
  mutate(
    recov = case_when(
      Type == "initial" ~ "initial",
      Type == "UC" ~ "Subcrust",
      TRUE ~ "recovering"
    )) |>
  mutate(Location = recode(Location, "Mesa" = "SF")) |>
  mutate(Succession = factor(Succession, levels = c("Light", "Dark", "Elevated"))) |>
  mutate(Type = factor(Type, levels = c("initial", "UC", "YR1", "reinoculated"))) |>
  mutate(Location = str_remove(Location, "E")) |>
  mutate(Location = factor(Location, levels = c("DG", "LV", "DD", "ND", "LC", "25", "31", "SF"))) |>
  mutate(recov = factor(recov, levels = c("initial", "Subcrust", "recovering"))) |>
  slice(-1) |> 
  as.data.frame()

sample_index <- c("SF", "DG", "LV", "DD", "ND", "LC", "25", "31")  

```
### Chlorophyll comparisons - Borrow site and Kin transplant
```{r message=FALSE}
Chla_transplant_borrowarea <- read_excel("Chla_transplant_borrowarea.xlsx",
                                         sheet = "Chl A", range = "B2:U35") |>
  dplyr::select(1,last_col()) |>
  rename(SampleID = 1, Chla = 2)

Chla_transplant <- Chla_transplant_borrowarea |>
  slice(1:15) |>
  add_row(SampleID = factor("", levels = levels(Chla_transplant$SampleID)), 
          Chla = NA) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "ND"), "Original", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "clump"), "Transplanted", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "Vert"), "Farm Soil", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "CP"), "Proximal", SampleID)) |>
  mutate(SampleID = factor(SampleID, levels = c("Original", "Transplanted", "", "Farm Soil", "Proximal")))
  
#Compute stats for transplant boxplot()
model_transplant <- aov(Chla ~ SampleID, data = Chla_transplant)

# Get Tukey comparisons and compact letter display
tukey_transplant <- glht(model_transplant, linfct = mcp(SampleID = "Tukey"))
cld_result_transplant <- cld(tukey_transplant)
summary(tukey_transplant)

# Extract the letters
max_y_transplant <- max(Chla_transplant$Chla, na.rm = TRUE) * 1.1

letter_df_transplant <- data.frame(
  SampleID = factor(c("Original", "Transplanted", "Farm Soil", "Proximal"),
                    levels = c("Original", "Transplanted", "", "Farm Soil", "Proximal")),
  letter_transplant = c("a", "b", "c", "c"),
  y_pos = max_y_transplant  # Add explicit y position
)

##
Chla_borrowarea <- Chla_transplant_borrowarea |>
  slice(16:33) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "YR1"), "Year 1", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "YR2"), "Year 2", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "uc"), "Undercrust", SampleID)) |>
  mutate(SampleID = ifelse(str_detect(SampleID, "DF"), "Initial", SampleID)) |>
  mutate(SampleID = factor(SampleID))

#Compute stats for borrow area boxplot()
model_borrow <- aov(Chla ~ SampleID, data = Chla_borrowarea)

# Get Tukey comparisons and compact letter display
tukey_borrow <- glht(model_borrow, linfct = mcp(SampleID = "Tukey"))
cld_result_borrow <- cld(tukey_borrow)

# Extract the letters
letter_df_borrow <- data.frame(
  SampleID = names(cld_result_borrow$mcletters$Letters),
  letter_borrow = cld_result_borrow$mcletters$Letters
)

## Transplant boxplot
transplant_plot <- ggplot(Chla_transplant, aes(x = factor(SampleID), y = Chla)) +
  geom_boxplot(fill = "green", alpha = 0.4) +
  ylab("") +
  xlab("") +
  geom_text(data = letter_df_transplant, 
            aes(x = SampleID, y = y_pos, label = letter_transplant),
            size = 5) +
  theme_minimal() +
  theme(legend.position = "none") +
  theme(legend.position = "none",
        panel.grid = element_blank(),           # Remove all gridlines
        axis.line = element_line(color = "black"))  # Add x and y axis lines
ggsave("transplant_plot.png", plot = transplant_plot, width = 4.5, height = 4.5, dpi = 300)

## Calculate pct recovery
pct_recov <- Chla_borrowarea |>
  group_by(SampleID) |>
  summarise(Chla = mean(Chla, na.rm = TRUE)) |>
  mutate(SampleID = case_when(
    SampleID == 'Year 1' ~ "YR1",
    SampleID == 'Year 2' ~ "YR2",
    TRUE ~ SampleID
  )) |>
  pivot_wider(names_from = SampleID, values_from = Chla) |>
  mutate(YR1_recov = ((YR1 - Undercrust) / (Initial)) * 100) |>
  mutate(YR2_recov = ((YR2 - Undercrust) / (Initial)) * 100)


## Borrow area recovery boxplot
# Create formatted text
YR1_text <- paste0(round(pct_recov$YR1_recov, 1), " %")
YR2_text <- paste0(round(pct_recov$YR2_recov, 1), " %")

# Create a dataframe for the annotations
recov_df <- data.frame(
  x = c(3, 4),  # x positions for boxes 3 and 4
  y = c(14, 38),  # Adjust these y values as needed
  label = c(YR1_text, YR2_text)
)

# Add to your plot
borrow_plot <- ggplot(Chla_borrowarea, aes(x = factor(SampleID), y = Chla)) +
  geom_boxplot(fill = "green", alpha = 0.4) +
  ylab(expression("Chlorophyll a (mg m"^-2*")")) +
  xlab("") +
  geom_text(data = letter_df_borrow, 
            aes(x = SampleID, y = max(Chla_borrowarea$Chla) * 1.1, label = letter_borrow),
            size = 5) +
  geom_text(data = recov_df,
            aes(x = x, y = y, label = label),
            size = 4) +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid = element_blank(),
        axis.line = element_line(color = "black"))
borrow_plot
ggsave("borrow_plot.png", plot = borrow_plot, width = 4.5, height = 4.5, dpi = 300)

```
### Bacterial 16S reads + taxonomy
```{r message=FALSE}

taxonomy_all_bacteria <- read_csv("taxonomy_all_bacteria.csv") |>
  rename("OTUID" = "#OTUID") |>
  rename("taxon" = 2) |>
  filter(!grepl("Chloroplast", taxon)) |> ## eliminate  chloroplasts
  filter(!grepl("Archaea", taxon)) |> ## eliminate a few more rogue chloroplasts
  filter(!grepl("ML635J", taxon)) |> 
  filter(!grepl("4C0d-2", taxon)) |> 
  filter(!grepl("ba371aa9568f05e8ae4af388e131c559", OTUID)) |>
  filter(!grepl("d8538534976f29d37687e45592bcba7f", OTUID)) |>
  filter(!grepl("fa1f8821c8cc6fe1ea70337464b68210", OTUID)) |>
  filter(!grepl("faae417a5cce12c63199f40d14b2ccc5", OTUID)) |>
  as.data.frame()

taxonomy_bacteria_no_cyanos <- taxonomy_all_bacteria |>
  dplyr::filter(!grepl("Cyano", taxon)) |>
  as.data.frame()

ASV_reads_all_bacteria <- read_csv("reads_all_bacteria.csv") |>
  rename(OTUID = 1) |>
  semi_join(taxonomy_all_bacteria, by = "OTUID") |>  # keeps only matching rows
  left_join(taxonomy_all_bacteria %>% 
  dplyr::select(OTUID, taxon), by = "OTUID") |>
  as.data.frame() |>
  dplyr::select(!matches("EICP")) |>
  dplyr::select(!matches("YR2")) |>
  rename_with(~ str_replace(., "LIC", "LC"), contains("LIC"))
```
### Cyanobacteria reads
```{r message=FALSE, warning=FALSE}
identified_cyanos <- read_csv("identified_cyanos.csv")
cydrasil_cyano_reads <- read_csv("cyano_reads_w_taxonomy.csv") |>
  dplyr::select(!matches("EICP")) |>
  dplyr::select(!matches("YR2"))

taxonomy_cyanos <- ASV_reads_all_bacteria |>
  filter(str_detect(taxon, "Cyano")) |>
  dplyr::select(OTUID, taxon)

ASV_reads_bacteria_no_cyanos <- ASV_reads_all_bacteria |>
  filter(!str_detect(taxon, "Cyano")) |>
  dplyr::select(!taxon)

ASV_reads_cyanos <- ASV_reads_all_bacteria |>
  filter(str_detect(taxon, "Cyano")) |>
  dplyr::select(!taxon)

############# Cydrasil cyano identifications ###################
Genus_cyano_reads <- ASV_reads_cyanos |>
  left_join(identified_cyanos) |>
  dplyr::select(Genus, everything()) |>
  dplyr::select(-OTUID, -taxon) |>
  group_by(Genus) |>
  summarise(across(everything(), sum, na.rm = TRUE), .groups = "drop") |>
  pivot_longer(-Genus, names_to = "Sample_id", values_to = "ReadCount") |>
  pivot_wider(names_from = Genus, values_from = ReadCount)

UC_cyanos <- Genus_cyano_reads |>
  filter(grepl("UC", Sample_id))
write.csv(UC_cyanos, file = "subcrust_cyanos.csv")

biocrust_cyanos <- Genus_cyano_reads |>
  filter(grepl("init", Sample_id))
write.csv(biocrust_cyanos, file = "biocrust_cyanos.csv")

init_cyanos <- Genus_cyano_reads |>
  filter(grepl("init", Sample_id))

recov_cyanos <- Genus_cyano_reads |>
  filter(grepl("YR1", Sample_id)) |>
  filter(!grepl("YR12", Sample_id)) |>
  filter(!grepl("re", Sample_id))
```
## CAP Plot template 
```{r message=FALSE, warning=FALSE}
style_ord_plot <- function(p) {
  p +
    geom_point(aes(shape = Location, color = Type), size = 2) +
    stat_ellipse(aes(x = CAP1, y = CAP2, group = Type, color = Type), type = "t", linetype = 2, level = 0.95) +
    scale_color_manual(
      name = "Sample Type",
      values = c(
        "initial" = "turquoise",
        "YR1" = "darkgreen",
        "reinoculated" = "brown1",
        "UC" = "orange"
      ),
      labels = c(
        "initial" = "Biocrust",
        "YR1" = "Recovering",
        "reinoculated" = "Re-inoculated",
        "UC" = "Undercrust"
      )
    ) +
    scale_shape_manual(
      name = "Site",
      values = c(1, 2, 3, 4, 5, 6, 8, 9)
    ) +
    theme(
      panel.background = element_blank(),
      plot.background = element_blank(),
      panel.border = element_blank(),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      axis.text = element_text(size = 10),
      axis.title.y = element_text(size = 10),
      axis.title.x = element_text(size = 10, margin = margin(t = 10)),
      axis.line = element_line(color = "black"),
      legend.title = element_text(size = 10),
      legend.text = element_text(size = 9),
      legend.background = element_blank(),      # Removes the legend box background
      legend.box.background = element_blank()
    )
}
```
## Cyanos - Jaccard - PCA chart
```{r message=FALSE, warning=FALSE}
################
## cyanos ##
#Preparing tables for phyloseq
phy_metadata <- metadata #|>
  #filter(Location != "SF")
rownames(phy_metadata) <- phy_metadata$sampleid 
phy_metadata$sampleid <- NULL

phy_cyano_taxa_table <- taxonomy_cyanos |>
  column_to_rownames("OTUID")

phy_reads_cyanos <- ASV_reads_cyanos #|>
#dplyr::select(!matches("M")) 
rownames(phy_reads_cyanos) <- phy_reads_cyanos$OTUID 
phy_reads_cyanos$OTUID <- NULL

cyano_otu_table_phy <- otu_table(as.matrix(phy_reads_cyanos), taxa_are_rows = TRUE)
# pyloseq Taxonomy table
cyano_tax_table_phy <- tax_table(as.matrix(phy_cyano_taxa_table))
# phyloseq Sample data
cyano_sample_data_phy <- sample_data(phy_metadata)
#sample_data_phy1 <- sample_data(sample_data_filtered1)
physeq_cyanos <- phyloseq(cyano_otu_table_phy, cyano_sample_data_phy, cyano_tax_table_phy)

## Transform data for jaccard
physeq_jaccard_t_cyanos = transform_sample_counts(physeq_cyanos, function(x) ifelse(x > 0, 1, 0)) # Jaccard

jc_otu_bin <- as(otu_table(physeq_jaccard_t_cyanos), "matrix")
if (taxa_are_rows(physeq_jaccard_t_cyanos)) {
  jc_otu_bin <- t(jc_otu_bin)
}

jc_non_empty <- rowSums(jc_otu_bin) > 0
jc_otu_bin <- jc_otu_bin[jc_non_empty, ]
jaccard_cyano_dist <- vegdist(jc_otu_bin, method = "jaccard")

jc_meta <- as(sample_data(physeq_jaccard_t_cyanos), "data.frame")
jc_meta <- jc_meta[rownames(jc_otu_bin), ]  # match samples

cap_jaccard_cyano <- capscale(jaccard_cyano_dist ~ Type, data = jc_meta)

# Axis scores
jc_scores_df <- as.data.frame(scores(cap_jaccard_cyano)$sites)
jc_scores_df$SampleID <- rownames(jc_scores_df)
jc_scores_df <- cbind(jc_scores_df, jc_meta)
jc_scores_df$Location <- factor(jc_scores_df$Location, levels = sample_index)

jc_var_expl <- cap_jaccard_cyano$CCA$eig / sum(cap_jaccard_cyano$CCA$eig)
x_lab_j_c <- paste0("CAP1 (", round(jc_var_expl[1] * 100, 1), "%)")
y_lab_j_c <- paste0("CAP2 (", round(jc_var_expl[2] * 100, 1), "%)")

jc_p <- ggplot(jc_scores_df, aes(x = CAP1, y = CAP2, color = Type, shape = Location)) +
  labs(x = x_lab_j_c, y = y_lab_j_c, title = "Jaccard - Cyanobacteria") +
  scale_x_reverse()

# Apply style
jc_final_plot <- style_ord_plot(jc_p)
jc_final_plot
ggsave("cyano_jaccard_CAP_plot.png", plot = jc_final_plot, width = 6, height = 4, dpi = 300)
```
## Cyanos - Jaccard - Stats
```{r message=FALSE, warning=FALSE}
################
## Jaccard - cyanos - stats ##
## compare cyanobacteria ##
set.seed(7)
jc_adonis <- adonis2(jaccard_cyano_dist ~ Type, data = data.frame(sample_data(physeq_jaccard_t_cyanos)))
print(jc_adonis)

# If significant, run pairwise comparisons
jc_types <- levels(droplevels(sample_data(physeq_jaccard_t_cyanos)$Type))
jaccard_cyano_results_list <- list()

for (i in 1:(length(jc_types) - 1)) {
for (j in (i + 1):length(jc_types)) {
 
 group_i <- jc_types[i]
 group_j <- jc_types[j]
 
 jc_subset <- subset_samples(physeq_jaccard_t_cyanos, Type %in% c(group_i, group_j))
 
 # Get OTU table as binary matrix
 jc_otu_bin_subset <- as(otu_table(jc_subset), "matrix")
 if (taxa_are_rows(jc_subset)) {
   jc_otu_bin_subset <- t(jc_otu_bin_subset)
 }
 jc_otu_bin_subset <- ifelse(jc_otu_bin_subset > 0, 1, 0)

 # Filter samples with non-zero presence
 jc_otu_bin_subset <- jc_otu_bin_subset[rowSums(jc_otu_bin_subset) > 0, ]
 
 # Match metadata
 jc_meta_subset <- as(sample_data(jc_subset), "data.frame")
 jc_meta_subset <- jc_meta_subset[rownames(jc_otu_bin_subset), ]
 
 # Compute Jaccard distance
 jc_subset_dist <- vegdist(jc_otu_bin_subset, method = "jaccard")
 
 # Run adonis2
 jc_adonis_result <- adonis2(jc_subset_dist ~ Type, data = jc_meta_subset)
 
 # Store result
 jaccard_cyano_results_list[[paste(group_i, "vs", group_j)]] <- jc_adonis_result
}
}

#print(jaccard_cyano_results_list)
```
## Cyanos - Jaccard - Stats Summary Table
```{r message=FALSE, warning=FALSE}
##############################
## Create the summary table ##
jc_global_pval <- round(jc_adonis$`Pr(>F)`[1], 4)

# Create data frame with global result + a blank row as divider
jaccard_cyano_results_summary <- sapply(jaccard_cyano_results_list, function(x) x$`Pr(>F)`[1])
jaccard_cyano_results_df <- data.frame(
  Comparison = names(jaccard_cyano_results_summary),
  P_value = round(jaccard_cyano_results_summary, 4)
)

# Add overall result and a divider row
jc_overall_row <- data.frame(
  Comparison = "Overall PERMANOVA",
  P_value = jc_global_pval
)

divider_row <- data.frame(
  Comparison = "", 
  P_value = NA
)

jaccard_cyano_results_df <- rbind(
  jc_overall_row,
  divider_row,
  jaccard_cyano_results_df
)

# Build flextable
ft_jaccard_cyano <- flextable(jaccard_cyano_results_df) |>
  set_header_labels(
    Comparison = "Group Comparison",
    P_value = "P-value"
  ) |>
  add_header_row(
    values = "Jaccard - Cyanos: PERMANOVA Results",
    colwidths = 2
  ) |>
  align(align = "center", part = "all") |>
  bold(i = 1, part = "body") |>  # Emphasize global result
  autofit()

ft_jaccard_cyano
save_as_docx(ft_jaccard_cyano, path = "Jaccard_cyanos_PERMANOVA.docx")
```
## Other bacteria - Jaccard - PCA chart
```{r message=FALSE, warning=FALSE}
## bacteria no cyanos ##
#Preparing tables for phyloseq
phy_no_cyano_taxa_table <- taxonomy_bacteria_no_cyanos |>
  column_to_rownames("OTUID")

phy_reads_no_cyanos <- ASV_reads_bacteria_no_cyanos # |>
  #dplyr::select(!matches("M")) 
rownames(phy_reads_no_cyanos) <- phy_reads_no_cyanos$OTUID 
phy_reads_no_cyanos$OTUID <- NULL

no_cyano_otu_table_phy <- otu_table(as.matrix(phy_reads_no_cyanos), taxa_are_rows = TRUE)
# pyloseq Taxonomy table
no_cyano_tax_table_phy <- tax_table(as.matrix(phy_no_cyano_taxa_table))
# phyloseq Sample data
no_cyano_sample_data_phy <- sample_data(phy_metadata)
#sample_data_phy1 <- sample_data(sample_data_filtered1)
physeq_no_cyanos <- phyloseq(no_cyano_otu_table_phy, no_cyano_sample_data_phy, no_cyano_tax_table_phy)
## Transform data to presence/absence
physeq_jaccard_t_no_cyanos <- transform_sample_counts(physeq_no_cyanos, function(x) ifelse(x > 0, 1, 0))

## Convert to OTU matrix
otu_bin_jaccard_nc <- as(otu_table(physeq_jaccard_t_no_cyanos), "matrix")
if (taxa_are_rows(physeq_jaccard_t_no_cyanos)) {
  otu_bin_jaccard_nc <- t(otu_bin_jaccard_nc)
}

## Drop samples with zero counts
non_empty_jaccard_nc <- rowSums(otu_bin_jaccard_nc) > 0
otu_bin_jaccard_nc <- otu_bin_jaccard_nc[non_empty_jaccard_nc, ]

## Calculate Jaccard distances
jaccard_dist_nc <- vegdist(otu_bin_jaccard_nc, method = "jaccard")

## Prepare metadata
meta_jaccard_nc <- as(sample_data(physeq_jaccard_t_no_cyanos), "data.frame")
meta_jaccard_nc <- meta_jaccard_nc[rownames(otu_bin_jaccard_nc), ]

## CAP analysis
cap_jaccard_nc <- capscale(jaccard_dist_nc ~ Type, data = meta_jaccard_nc)

## Get axis scores
scores_df_jaccard_nc <- as.data.frame(scores(cap_jaccard_nc)$sites)
scores_df_jaccard_nc$SampleID <- rownames(scores_df_jaccard_nc)
scores_df_jaccard_nc <- cbind(scores_df_jaccard_nc, meta_jaccard_nc)
scores_df_jaccard_nc$Location <- factor(scores_df_jaccard_nc$Location, levels = sample_index)

## Axis labels
var_expl_jaccard_nc <- cap_jaccard_nc$CCA$eig / sum(cap_jaccard_nc$CCA$eig)
x_lab_j_nc <- paste0("CAP1 (", round(var_expl_jaccard_nc[1] * 100, 1), "%)")
y_lab_j_nc <- paste0("CAP2 (", round(var_expl_jaccard_nc[2] * 100, 1), "%)")

## Build plot
j_nc_p <- ggplot(scores_df_jaccard_nc, aes(x = CAP1, y = CAP2, color = Type, shape = Location)) +
  labs(x = x_lab_j_nc, y = y_lab_j_nc, title = "Jaccard - Other bacteria") + 
  scale_x_reverse() +
  scale_y_reverse()

## Apply styling
final_plot_jaccard_nc <- style_ord_plot(j_nc_p)
final_plot_jaccard_nc
ggsave("no_cyano_jaccard_CAP_plot.png", plot = final_plot_jaccard_nc, width = 6, height = 4, dpi = 300)
```
## Other bacteria - Jaccard - stats
```{r message=FALSE, warning=FALSE}
## bacteria no cyanos ##
################
## Jaccard - cyanos - stats ##
## compare cyanobacteria ##
set.seed(7)
j_nc_adonis <- adonis2(jaccard_dist_nc ~ Type, data = data.frame(sample_data(physeq_jaccard_t_no_cyanos)))
print(j_nc_adonis)

# If significant, run pairwise comparisons
j_nc_types <- levels(droplevels(sample_data(physeq_jaccard_t_no_cyanos)$Type))
jaccard_no_cyano_results_list <- list()

for (i in 1:(length(j_nc_types) - 1)) {
for (j in (i + 1):length(j_nc_types)) {
 
 group_i <- j_nc_types[i]
 group_j <- j_nc_types[j]
 
 j_nc_subset <- subset_samples(physeq_jaccard_t_no_cyanos, Type %in% c(group_i, group_j))
 
 # Get OTU table as binary matrix
 j_nc_otu_bin_subset <- as(otu_table(j_nc_subset), "matrix")
 if (taxa_are_rows(j_nc_subset)) {
   j_nc_otu_bin_subset <- t(j_nc_otu_bin_subset)
 }
 j_nc_otu_bin_subset <- ifelse(j_nc_otu_bin_subset > 0, 1, 0)

 # Filter samples with non-zero presence
 j_nc_otu_bin_subset <- j_nc_otu_bin_subset[rowSums(j_nc_otu_bin_subset) > 0, ]
 
 # Match metadata
 j_nc_meta_subset <- as(sample_data(j_nc_subset), "data.frame")
 j_nc_meta_subset <- j_nc_meta_subset[rownames(j_nc_otu_bin_subset), ]
 
 # Compute Jaccard distance
 j_nc_subset_dist <- vegdist(j_nc_otu_bin_subset, method = "jaccard")
 
 # Run adonis2
 j_nc_adonis_result <- adonis2(j_nc_subset_dist ~ Type, data = j_nc_meta_subset)
 
 # Store result
 jaccard_no_cyano_results_list[[paste(group_i, "vs", group_j)]] <- j_nc_adonis_result
}
}
#print(jaccard_no_cyano_results_list)
```
## Other bacteria - Jaccard - stats summary table
```{r message=FALSE, warning=FALSE}
## bacteria no cyanos ##
##############################
## Create the summary table ##
j_nc_global_pval <- round(j_nc_adonis$`Pr(>F)`[1], 4)

# Create data frame with global result + a blank row as divider
jaccard_no_cyano_results_summary <- sapply(jaccard_no_cyano_results_list, function(x) x$`Pr(>F)`[1])
jaccard_no_cyano_results_df <- data.frame(
  Comparison = names(jaccard_no_cyano_results_summary),
  P_value = round(jaccard_no_cyano_results_summary, 4)
)

# Add overall result and a divider row
j_nc_overall_row <- data.frame(
  Comparison = "Overall PERMANOVA",
  P_value = j_nc_global_pval
)

divider_row <- data.frame(
  Comparison = "", 
  P_value = NA
)

jaccard_no_cyano_results_df <- rbind(
  j_nc_overall_row,
  divider_row,
  jaccard_no_cyano_results_df
)

# Build flextable
ft_jaccard_no_cyano <- flextable(jaccard_no_cyano_results_df) |>
  set_header_labels(
    Comparison = "Group Comparison",
    P_value = "P-value"
  ) |>
  add_header_row(
    values = "Jaccard - Other bacteria: PERMANOVA Results",
    colwidths = 2
  ) |>
  align(align = "center", part = "all") |>
  bold(i = 1, part = "body") |>  # Emphasize global result
  autofit()

ft_jaccard_no_cyano
save_as_docx(ft_jaccard_no_cyano, path = "Jaccard_no_cyanos_PERMANOVA.docx")
```
## Combined stats summary table (Jaccard)
```{r message=FALSE, warning=FALSE}
## bacteria no cyanos ##
## Combine table - Jaccard ##
# Combine the underlying data.frames side by side
# Rename columns to avoid duplication
colnames(jaccard_cyano_results_df) <- c("Jaccard - Cyanos", "P value - Cyanos")
colnames(jaccard_no_cyano_results_df) <- c("Jaccard - Other bacteria", "P value - Others")

# Combine the data frames
df_j_combined <- cbind(jaccard_cyano_results_df, jaccard_no_cyano_results_df)

# Create flextable
library(flextable)
ft_j_combined <- flextable(df_j_combined)
ft_j_combined <- theme_booktabs(ft_j_combined)
ft_j_combined <- autofit(ft_j_combined)

# Show the result
ft_j_combined
save_as_docx(ft_j_combined, path = "Jaccard_PERMANOVA.docx")

```
## Cyanos - Bray Curtis - PCA chart
```{r message=FALSE, warning=FALSE}

################
## cyanos ##
# Extract OTU table
bc_otu_cyano_abund <- as(otu_table(physeq_cyanos), "matrix")
if (taxa_are_rows(physeq_cyanos)) {
  bc_otu_cyano_abund <- t(bc_otu_cyano_abund)
}

# Drop empty samples
non_empty_cyano_abund <- rowSums(bc_otu_cyano_abund) > 0
bc_otu_cyano_abund <- bc_otu_cyano_abund[non_empty_cyano_abund, ]

bray_cyano_dist <- vegdist(bc_otu_cyano_abund, method = "bray")

bc_cyano_meta <- as(sample_data(physeq_cyanos), "data.frame")
bc_cyano_meta <- bc_cyano_meta[rownames(bc_otu_cyano_abund), ]  # match samples

cap_bray_cyano <- capscale(bray_cyano_dist ~ Type, data = bc_cyano_meta)

# Axis scores
bc_cyano_scores_df <- as.data.frame(scores(cap_bray_cyano)$sites)
bc_cyano_scores_df$SampleID <- rownames(bc_cyano_scores_df)
bc_cyano_scores_df <- cbind(bc_cyano_scores_df, bc_cyano_meta)
bc_cyano_scores_df$Location <- factor(bc_cyano_scores_df$Location, levels = sample_index)

bc_cyano_var_expl <- cap_bray_cyano$CCA$eig / sum(cap_bray_cyano$CCA$eig)
x_lab_bc_c <- paste0("CAP1 (", round(bc_cyano_var_expl[1] * 100, 1), "%)")
y_lab_bc_c <- paste0("CAP2 (", round(bc_cyano_var_expl[2] * 100, 1), "%)")

bc_cyano_p <- ggplot(bc_cyano_scores_df, aes(x = CAP1, y = CAP2, color = Type, shape = Location)) +
  labs(x = x_lab_bc_c, y = y_lab_bc_c, title = "Bray-Curtis - Cyanobacteria") +
  scale_x_reverse()

# Apply style
bc_cyano_final_plot <- style_ord_plot(bc_cyano_p)
bc_cyano_final_plot
ggsave("cyano_bray_CAP_plot.png", plot = bc_cyano_final_plot, width = 6, height = 4, dpi = 300)
```
## Cyanos - Bray Curtis - stats
```{r message=FALSE, warning=FALSE}
##############################
## Create the summary table ##
## Bray-Curtis - cyanos - stats ##
set.seed(7)
bc_c_adonis <- adonis2(bray_cyano_dist ~ Type, data = data.frame(sample_data(physeq_cyanos)))
print(bc_c_adonis)
# If significant, run pairwise comparisons

bc_c_types <- levels(droplevels(sample_data(physeq_cyanos)$Type))
bray_cyano_results_list <- list()

for (i in 1:(length(bc_c_types) - 1)) {
for (j in (i + 1):length(bc_c_types)) {
 
 group_i <- bc_c_types[i]
 group_j <- bc_c_types[j]
 
 bc_c_subset <- subset_samples(physeq_cyanos, Type %in% c(group_i, group_j))
 
 # Get OTU table as binary matrix
 bc_c_otu_bin_subset <- as(otu_table(bc_c_subset), "matrix")
 if (taxa_are_rows(bc_c_subset)) {
   bc_c_otu_bin_subset <- t(bc_c_otu_bin_subset)
 }
 bc_c_otu_bin_subset <- ifelse(bc_c_otu_bin_subset > 0, 1, 0)

 # Filter samples with non-zero presence
 bc_c_otu_bin_subset <- bc_c_otu_bin_subset[rowSums(bc_c_otu_bin_subset) > 0, ]
 
 # Match metadata
 bc_c_meta_subset <- as(sample_data(bc_c_subset), "data.frame")
 bc_c_meta_subset <- bc_c_meta_subset[rownames(bc_c_otu_bin_subset), ]
 
 # Compute Jaccard distance
 bc_c_subset_dist <- vegdist(bc_c_otu_bin_subset, method = "bray")
 
 # Run adonis2
 bc_c_adonis_result <- adonis2(bc_c_subset_dist ~ Type, data = bc_c_meta_subset)
 
 # Store result
 bray_cyano_results_list[[paste(group_i, "vs", group_j)]] <- bc_c_adonis_result
}
}

#print(bray_cyano_results_list)
```
## Cyanos - Bray Curtis - stats summary table
```{r message=FALSE, warning=FALSE}
##############################
## Create the summary table ##
bc_c_global_pval <- round(bc_c_adonis$`Pr(>F)`[1], 4)

# Create data frame with global result + a blank row as divider
bray_cyano_results_summary <- sapply(bray_cyano_results_list, function(x) x$`Pr(>F)`[1])
bray_cyano_results_df <- data.frame(
  Comparison = names(bray_cyano_results_summary),
  P_value = round(bray_cyano_results_summary, 4)
)

# Add overall result and a divider row
bc_c_overall_row <- data.frame(
  Comparison = "Overall PERMANOVA",
  P_value = bc_c_global_pval
)

divider_row <- data.frame(
  Comparison = "", 
  P_value = NA
)

bray_cyano_results_df <- rbind(
  bc_c_overall_row,
  divider_row,
  bray_cyano_results_df
)

# Build flextable
ft_bray_cyano <- flextable(bray_cyano_results_df) |>
  set_header_labels(
    Comparison = "Group Comparison",
    P_value = "P-value"
  ) |>
  add_header_row(
    values = "Bray-Curtis - Cyanos: PERMANOVA Results",
    colwidths = 2
  ) |>
  align(align = "center", part = "all") |>
  bold(i = 1, part = "body") |>  # Emphasize global result
  autofit()

ft_bray_cyano
save_as_docx(ft_bray_cyano, path = "bray_cyanos_PERMANOVA.docx")
```
## Other bacteria (no cyanos) - Bray Curtis - PCA chart
```{r message=FALSE, warning=FALSE}
################
## cyanos ##
# Extract OTU table
bc_otu_no_cyano_abund <- as(otu_table(physeq_no_cyanos), "matrix")
if (taxa_are_rows(physeq_no_cyanos)) {
  bc_otu_no_cyano_abund <- t(bc_otu_no_cyano_abund)
}

# Drop empty samples
non_empty_no_cyano_abund <- rowSums(bc_otu_no_cyano_abund) > 0
bc_otu_no_cyano_abund <- bc_otu_no_cyano_abund[non_empty_no_cyano_abund, ]

bray_no_cyano_dist <- vegdist(bc_otu_no_cyano_abund, method = "bray")

bc_no_cyano_meta <- as(sample_data(physeq_no_cyanos), "data.frame")
bc_no_cyano_meta <- bc_no_cyano_meta[rownames(bc_otu_no_cyano_abund), ]  # match samples

cap_bray_no_cyano <- capscale(bray_no_cyano_dist ~ Type, data = bc_no_cyano_meta)

# Axis scores
bc_no_cyano_scores_df <- as.data.frame(scores(cap_bray_no_cyano)$sites)
bc_no_cyano_scores_df$SampleID <- rownames(bc_no_cyano_scores_df)
bc_no_cyano_scores_df <- cbind(bc_no_cyano_scores_df, bc_no_cyano_meta)
bc_no_cyano_scores_df$Location <- factor(bc_no_cyano_scores_df$Location, levels = sample_index)

bc_no_cyano_var_expl <- cap_bray_no_cyano$CCA$eig / sum(cap_bray_no_cyano$CCA$eig)
x_lab_bc_nc <- paste0("CAP1 (", round(bc_no_cyano_var_expl[1] * 100, 1), "%)")
y_lab_bc_nc <- paste0("CAP2 (", round(bc_no_cyano_var_expl[2] * 100, 1), "%)")

bc_no_cyano_p <- ggplot(bc_no_cyano_scores_df, aes(x = CAP1, y = CAP2, color = Type, shape = Location)) +
  labs(x = x_lab_bc_nc, y = y_lab_bc_nc, title = "Bray-Curtis - Other bacteria") +
  scale_x_reverse()

# Apply style
bc_no_cyano_final_plot <- style_ord_plot(bc_no_cyano_p)
bc_no_cyano_final_plot
ggsave("no_cyano_bray_CAP_plot.png", plot = bc_no_cyano_final_plot, width = 6, height = 4, dpi = 300)
```
## Other bacteria - Bray Curtis - stats
```{r message=FALSE, warning=FALSE}
##############################
## Create the summary table ##
## Bray-Curtis - cyanos - stats ##
set.seed(7)
bc_nc_adonis <- adonis2(bray_no_cyano_dist ~ Type, data = data.frame(sample_data(physeq_no_cyanos)))
print(bc_nc_adonis)
# If significant, run pairwise comparisons

bc_nc_types <- levels(droplevels(sample_data(physeq_no_cyanos)$Type))
bray_no_cyano_results_list <- list()

for (i in 1:(length(bc_nc_types) - 1)) {
for (j in (i + 1):length(bc_nc_types)) {
 
 group_i <- bc_nc_types[i]
 group_j <- bc_nc_types[j]
 
 bc_nc_subset <- subset_samples(physeq_no_cyanos, Type %in% c(group_i, group_j))
 
 # Get OTU table as binary matrix
 bc_nc_otu_bin_subset <- as(otu_table(bc_nc_subset), "matrix")
 if (taxa_are_rows(bc_nc_subset)) {
   bc_nc_otu_bin_subset <- t(bc_nc_otu_bin_subset)
 }
 bc_nc_otu_bin_subset <- ifelse(bc_nc_otu_bin_subset > 0, 1, 0)

 # Filter samples with non-zero presence
 bc_nc_otu_bin_subset <- bc_nc_otu_bin_subset[rowSums(bc_nc_otu_bin_subset) > 0, ]
 
 # Match metadata
 bc_nc_meta_subset <- as(sample_data(bc_nc_subset), "data.frame")
 bc_nc_meta_subset <- bc_nc_meta_subset[rownames(bc_nc_otu_bin_subset), ]
 
 # Compute Bray Curtis distance
 bc_nc_subset_dist <- vegdist(bc_nc_otu_bin_subset, method = "bray")
 
 # Run adonis2
 bc_nc_adonis_result <- adonis2(bc_nc_subset_dist ~ Type, data = bc_nc_meta_subset)
 
 # Store result
 bray_no_cyano_results_list[[paste(group_i, "vs", group_j)]] <- bc_nc_adonis_result
}
}

#print(bray_no_cyano_results_list)
```
## Other bacteria - Bray Curtis - stats summary table
```{r message=FALSE, warning=FALSE}
##############################
## Create the summary table ##
bc_nc_global_pval <- round(bc_nc_adonis$`Pr(>F)`[1], 4)

# Create data frame with global result + a blank row as divider
bray_no_cyano_results_summary <- sapply(bray_no_cyano_results_list, function(x) x$`Pr(>F)`[1])
bray_no_cyano_results_df <- data.frame(
  Comparison = names(bray_no_cyano_results_summary),
  P_value = round(bray_no_cyano_results_summary, 4)
)

# Add overall result and a divider row
bc_nc_overall_row <- data.frame(
  Comparison = "Overall PERMANOVA",
  P_value = bc_c_global_pval
)

divider_row <- data.frame(
  Comparison = "", 
  P_value = NA
)

bray_no_cyano_results_df <- rbind(
  bc_nc_overall_row,
  divider_row,
  bray_no_cyano_results_df
)

# Build flextable
ft_bray_no_cyano <- flextable(bray_no_cyano_results_df) |>
  set_header_labels(
    Comparison = "Group Comparison",
    P_value = "P-value"
  ) |>
  add_header_row(
    values = "Bray-Curtis - Other bacteria: PERMANOVA Results",
    colwidths = 2
  ) |>
  align(align = "center", part = "all") |>
  bold(i = 1, part = "body") |>  # Emphasize global result
  autofit()

ft_bray_no_cyano
save_as_docx(ft_bray_no_cyano, path = "bray_no_cyanos_PERMANOVA.docx")
```
## Combined stats summary table (Bray Curtis)
```{r message=FALSE, warning=FALSE}
## Combine table - Briay Curtis ##
# Combine the underlying data.frames side by side
# Rename columns to avoid duplication
colnames(bray_cyano_results_df) <- c("Bray-Curtis - Cyanos", "P value - Cyanos")
colnames(bray_no_cyano_results_df) <- c("Bray-Curtis - Other bacteria", "P value - Others")

# Combine the data frames
df_bc_combined <- cbind(bray_cyano_results_df, bray_no_cyano_results_df)

ft_bc_combined <- flextable(df_bc_combined)
ft_bc_combined <- theme_booktabs(ft_bc_combined)
ft_bc_combined <- autofit(ft_bc_combined)

# Show the result
ft_bc_combined
save_as_docx(ft_bc_combined, path = "BrayCurtis_PERMANOVA.docx")
```
## Import 16S read data
```{r, message=FALSE}
qPCR <- read_excel("qPCR_biocrust recovery_summary_part2.xlsx", 
    sheet = "Results Summary", 
    range = "B11:I111", col_types = c("text", "numeric", "numeric", "numeric", "numeric","numeric", "numeric", "numeric")) |>
  rename("Sample_id" = 1, "genes_per_mgSoil" = 8) |>
  dplyr::select(1,8) |>
   mutate(Type = case_when(
    grepl("i1|i2|i3", Sample_id) ~ "init",
    grepl("uc", Sample_id) ~ "UC",
    grepl("A1|A2|A3", Sample_id) ~ "April",
    grepl("J1|J2|J3", Sample_id) ~ "Jun",
    TRUE ~ NA_character_  # For rows that don't match, keep NA
  )) |>
  mutate(Type = if_else(is.na(Type), case_when(
    grepl("Mesa1g|Mesa2d|Mesa3d", Sample_id) ~ "init",
    grepl("_YR1", Sample_id) ~ "April",
    TRUE ~ NA_character_
  ), Type)) |>
  #mutate(logGene = log10(genes_per_mgSoil)) |>
  filter(!is.na(Type)) |>
  mutate(Sample_id = str_replace(Sample_id, "^25", "25")) |>
  mutate(Sample_id = str_replace(Sample_id, "^31", "31")) |>
  mutate(Sample_id = str_replace(Sample_id, "Lic", "LC"))

qPCR$Type <- factor(qPCR$Type, levels = c("init", "UC", "April", "Jun"))

### Summarize counts to calculate cyano and non_cyano gene numbers
total_bac_reads <- ASV_reads_all_bacteria |>
  dplyr::select(-taxon) |>
  dplyr::select(!OTUID) |>
  t() |>
  as.data.frame() |>
  mutate(all_bac = rowSums(across(everything()))) %>%  # add row sums as "All_bac"
  dplyr::select(all_bac)

total_cyano_reads <- ASV_reads_cyanos |>
  dplyr::select(!OTUID) |>
  t() |>
  as.data.frame() |>
  mutate(all_cyanos = rowSums(across(everything()))) %>%  # add row sums as "All_bac"
  dplyr::select(all_cyanos)

##############################
all_reads_summary <- cbind(total_bac_reads, total_cyano_reads) |>
  mutate(bac_not_cyanos = all_bac - all_cyanos) |>
  rownames_to_column(var = "Sample_id") |>
  filter(str_detect(Sample_id, "init|UC") | str_detect(Sample_id, "YR1$"))|>  
  mutate(Type = str_extract(Sample_id, "init|UC|YR1"), Sample_id = str_remove(Sample_id, "init|UC|YR1")) |>
  mutate(Sample_id = str_remove(Sample_id, "00")) |>
  mutate(Sample_id = str_remove(Sample_id, "E")) |>
  mutate(Sample_id = str_replace(Sample_id, "M1G", "SF1")) |>
  mutate(Sample_id = str_replace(Sample_id, "M2D", "SF2")) |>
  mutate(Sample_id = str_replace(Sample_id, "M3D", "SF3")) |>
  mutate(Sample_id = str_replace(Sample_id, "LIC", "LC"))

###################################################
## Combine replicate LV samples
lv_avg <- all_reads_summary %>%
  filter(str_detect(Sample_id, "^LV[1-3]$")) %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), mean), .groups = "drop") %>%
  mutate(Sample_id = "LV")

## Combine replicate LV samples
SF_avg <- all_reads_summary %>%
  filter(str_detect(Sample_id, "^SF[1-3]$")) %>%
  group_by(Type) %>%
  summarise(across(where(is.numeric), mean), .groups = "drop") |>
  mutate(Sample_id = "SF")

all_reads_summary <- all_reads_summary |>
  filter(!str_detect(Sample_id, "^LV[1-3]$")) |>
  filter(!str_detect(Sample_id, "^SF[1-3]$")) |>
  bind_rows(lv_avg, SF_avg) |>
  mutate(Type = str_replace(Type, "YR1", "April"))

##############
### Subset tables for crust_subcrust comparison ###
all_reads_summary_crust_sub <- all_reads_summary  |>
  filter(!str_detect(Sample_id, "YR1")) 

############################################################
qPCR_summary <- qPCR |>
  filter(Type %in% c("init", "UC", "April")) |>
  mutate(
    Sample_id = str_remove(Sample_id, "i|uc"),
    Sample_id = gsub("Mesa", "SF", Sample_id),
    Sample_id = gsub("M", "SF", Sample_id),
    Sample_id = gsub("_YR1", "", Sample_id),
    Sample_id = gsub("g|d", "", Sample_id),
    replicate = str_sub(Sample_id, -1),
    Sample_id = str_sub(Sample_id, 1, -2),
    Sample_id = str_replace(Sample_id, "Lci", "LC"),
    Sample_id = str_replace(Sample_id, "Lcuc", "LC"),
    Sample_id = if_else(str_detect(Sample_id, "A"), str_remove(Sample_id, "A"), Sample_id))
    
qPCR_crust_sub <- qPCR_summary |>
  filter(Type %in% c("init", "UC")) 

qPCR_w_reads <- qPCR_summary %>%
  left_join(all_reads_summary, by = c("Sample_id", "Type")) |>
  mutate(cyano_genes = all_cyanos/all_bac*genes_per_mgSoil) |>
  mutate(bac_no_cyano_genes = bac_not_cyanos/all_bac*genes_per_mgSoil) |>
  group_by(Sample_id, Type) |>
  summarise(across(where(is.numeric), mean, na.rm = TRUE), 
  .groups = "drop") |>
  mutate(across(where(is.numeric), ~ .x / 1e5)) |>
  dplyr::select(1,2,7,8) |>
  mutate(Type = str_replace(Type, "April", "Recovered")) |>
  mutate(Type = str_replace(Type, "UC", "Subcrust")) |>
  mutate(Type = str_replace(Type, "init", "Biocrust"))

### Add ratios and Resilience
################ cyanos
cyano_w_reads <- qPCR_w_reads |>
  dplyr::select(1:3) |>
   pivot_wider(
    names_from = Type,
    values_from = where(is.numeric),
    names_sep = "."
  ) |>
  mutate(`B:S Ratio` = Biocrust / Subcrust) |>
  mutate(Recovery = (Recovered - Subcrust)/Biocrust * 100) |>
  pivot_longer(cols = -Sample_id, names_to = "Layer", values_to = "16S genes") |>
  pivot_wider(names_from = Sample_id,
    values_from = where(is.numeric),
    names_sep = "."
  ) |>
  mutate(Measurement = "Cyanobacteria") |>
  dplyr::select(Measurement, Layer, all_of(sample_index))

################ other bacteria
bacteria_w_reads <- qPCR_w_reads |>
  dplyr::select(1,2,4) |>
   pivot_wider(
    names_from = Type,
    values_from = where(is.numeric),
    names_sep = "."
  ) |>
  mutate(`B:S Ratio` = Biocrust / Subcrust) |>
  mutate(Recovery = (Recovered - Subcrust)/Biocrust * 100) |>
  pivot_longer(cols = -Sample_id, names_to = "Layer", values_to = "16S genes") |>
  pivot_wider(names_from = Sample_id,
    values_from = where(is.numeric),
    names_sep = "."
  ) |>
  mutate(Measurement = "Other Bacteria") |>
  dplyr::select(Measurement, Layer, all_of(sample_index))
```
## Chlorophyll analysis and Biocrtust Recovery
```{R}
Chl <- read_excel("Chl.xlsx", sheet = "Chl A", range = "A2:AA144") |>
  dplyr::select(2, 3, 4, 20, 27) |>
  rename("Sample_id" = 3, "μgChl_m2" = 4, "μgChl_g" = 5) |>
  filter(!is.na(μgChl_m2) & μgChl_m2 != "") |>
  filter(!is.na(μgChl_g) & μgChl_g != "") |>
  filter(!is.na(month) & month != "") |>
  mutate(Sample_id = str_replace(Sample_id, "Lic", "LC"))

Chl_recov <- Chl |>
  filter(type %in% c("Crust", "UC", "YR1")) |>
  mutate(Sample_id = gsub("\\(g\\)", "", Sample_id)) %>%
  mutate(Sample_id = gsub("\\(d\\)", "", Sample_id)) |>
  mutate(rep = substr(Sample_id, nchar(Sample_id), nchar(Sample_id))) |>
  mutate(Sample_id = gsub("-[1-3]$", "", Sample_id)) |>
  mutate(Sample_id = gsub("uc|recov", "", Sample_id)) |>
  mutate(Sample_id = gsub("3100", "31", Sample_id)) |>
  mutate(Sample_id = gsub("2500", "25", Sample_id)) |>
  mutate(Sample_id = gsub("Mesa", "SF", Sample_id)) |>
  mutate(Sample_id = factor(Sample_id, levels = c("SF", "DG", "LV", "DD", "ND", "LC", "25", "31"))) |>
  filter(month != "June") |>
  arrange(type, Sample_id, μgChl_m2) |>
  group_by(type, Sample_id) %>%       # Group by "type" and "Sample_id"
  mutate(index = row_number()) %>%    # Add an index column
  ungroup() |>
  mutate(μgChl_m2 = ifelse(μgChl_m2 < 0, 0, μgChl_m2)) 

June_Chl_recov <- Chl |>
  filter(month == "June") |>
  filter(type != "special") |>
  mutate(Sample_id = substr(Sample_id, 1,2)) |>
  mutate(Sample_id = ifelse(str_detect(Sample_id,"M"), "Mesa", Sample_id)) |>
  mutate(Sample_id = gsub("3100", "31", Sample_id)) |>
  mutate(Sample_id = gsub("2500", "25", Sample_id)) |>
  filter(!(Sample_id == "Mesa" & type == "re-inoc")) |>
  mutate(Sample_id = gsub("Mesa", "SF", Sample_id)) |>
  mutate(type ="June") |>
  arrange(type, Sample_id, μgChl_m2) |>
  group_by(type, Sample_id) %>%       # Group by "type" and "Sample_id"
  mutate(index = row_number()) %>%    # Add an index column
  ungroup() 

Chl_recov_all <- bind_rows(Chl_recov, June_Chl_recov) |>
   mutate(
    Succession = case_when(
      Sample_id %in% c("Mesa", "DG", "LV") ~ "Light",
      Sample_id %in% c("DD", "ND", "Lic") ~ "Dark",
      Sample_id %in% c("E25", "E31") ~ "Higher Altitude",
      TRUE ~ "Other"  # Optional: Label any other values
    )
  )

Chl_recov_summary <- Chl_recov_all %>%
  dplyr::select(Sample_id, type, μgChl_m2, index) %>%
  pivot_wider(names_from = type, values_from = μgChl_m2, names_prefix = "μgChl_m2_") %>%
  mutate(may_pct_recov = (μgChl_m2_YR1 - μgChl_m2_UC) / (μgChl_m2_Crust)) %>% # assumes 5% innoculation ()
  mutate(jun_pct_recov = (μgChl_m2_June - μgChl_m2_UC) / (μgChl_m2_Crust)) %>%
  group_by(Sample_id) %>%
  summarise(
    may_mean_pct_recov = mean(may_pct_recov, na.rm = TRUE),
    may_se_pct_recov = sd(may_pct_recov, na.rm = TRUE) / sqrt(n()),
    jun_mean_pct_recov = mean(jun_pct_recov, na.rm = TRUE),
    jun_se_pct_recov = sd(jun_pct_recov, na.rm = TRUE) / sqrt(n()),
    .groups = 'drop'
  ) |>
  # rename("Chla % Recovered (YR1)" = mean_pct_recov, "SE" = se_pct_recov) |>
  mutate(across(where(is.numeric), ~ round(. * 100, 1))) |>
  mutate(formatted_may_mean_pct_recov = format(may_mean_pct_recov, nsmall = 1)) |>
  mutate(formatted_jun_mean_pct_recov = format(jun_mean_pct_recov, nsmall = 1)) |>
  mutate(formatted_may_se_pct_recov = format(may_se_pct_recov, nsmall = 1)) |>
  mutate(formatted_jun_se_pct_recov = format(jun_se_pct_recov, nsmall = 1)) |>
  mutate(may_pct_chl_recov = str_c(formatted_may_mean_pct_recov, " ± ", formatted_may_se_pct_recov)) |>
  mutate(jun_pct_chl_recov = str_c(formatted_jun_mean_pct_recov, " ± ", formatted_jun_se_pct_recov)) |>
  mutate(order = match(Sample_id, sample_index)) |>                               # Arrange rows by the order column
  arrange(order) %>%                                # Arrange rows by the order column
  dplyr::select(-order) |>
  mutate(Sample_id = str_remove(Sample_id, "E"))

###
## Calculate initial values of Chla and scytonemin in the natural biocrust layers
Chl_summary <- Chl_recov_all %>%
  dplyr::select(Sample_id, type, μgChl_m2, index) %>%
  dplyr::select(Sample_id, type, μgChl_m2, index) |>
  pivot_wider(names_from = type, values_from = μgChl_m2, names_prefix = "μgChl_m2_") |>
  dplyr::select(1, 3:5) |>
  group_by(Sample_id) %>%
  summarise(
    Biocrust = mean(μgChl_m2_Crust, na.rm = TRUE),
    Subcrust = mean(μgChl_m2_UC, na.rm = TRUE),
    Recovered = mean(μgChl_m2_YR1, na.rm = TRUE),
    .groups = 'drop'
  ) |>
  mutate(`B:S Ratio` = Biocrust/Subcrust) |> 
  mutate(Recovery = (Recovered - Subcrust)/Biocrust * 100) |>
  pivot_longer(cols = -Sample_id, names_to = "Layer", values_to = "μgChl_m2") %>%
  pivot_wider(names_from = Sample_id, values_from = μgChl_m2) |>
  mutate(Measurement = "Chlorophyll a") |>
  dplyr::select(Measurement, Layer, all_of(sample_index))


```
##Flextables: Biocrust, subcrust, recovered biocrust, resilience
```{R}
## Create table, Chl_Crust_UC_summary is in correct order, so must go first
complete_table_by_Sample_id <- bind_rows(cyano_w_reads, bacteria_w_reads, Chl_summary) 

complete_table_by_Sample_id$Measurement <- factor(complete_table_by_Sample_id$Measurement, levels = c("Cyanobacteria", "Other Bacteria", "Chlorophyll a"))

## Correct row order
complete_table_by_Sample_id <- complete_table_by_Sample_id |>
  mutate(Layer = gsub("Subcrust", "Undercrust", Layer)) |>
  mutate(Layer = gsub("Recovered", "Recovering", Layer)) |>
  mutate(Layer = gsub("Recovery", "% Recovery", Layer)) |>
  arrange(Measurement, Layer)

complete_table_by_Sample_id <- complete_table_by_Sample_id |>
  mutate(SF = case_when(
    Measurement == "Chlorophyll a" & Layer == "Undercrust" ~ 0.02,
    TRUE ~ SF
  )) |>
  mutate(LC = case_when(
    Measurement == "Chlorophyll a" & Layer == "Undercrust" ~ 0.02,
    TRUE ~ LC
  )) |>
  mutate(Layer = factor(Layer, levels = c("Biocrust", "Undercrust", "Recovering", "B:S Ratio", "% Recovery"))) |>
  arrange(Measurement, Layer)

f_complete_table_by_Sample_id <- complete_table_by_Sample_id |>
  mutate(row = row_number()) |>
  rowwise() |>
  mutate(across(
    where(is.numeric),
    ~ case_when(
      row == 1 ~ formatC(., digits = 0, format = "f"),
      row == 2 ~ formatC(., format = "f", digits = 2),
      row == 3 ~ formatC(., digits = 1, format = "f"),
      row == 4 ~ formatC(., digits = 0, format = "f"),
      row == 5 ~ formatC(., digits = 1, format = "f"),
      row == 6 ~ formatC(., digits = 0, format = "f"),
      row == 7 ~ formatC(., digits = 1, format = "f"),
      row == 8 ~ formatC(., digits = 2, format = "f"),
      row == 9 ~ formatC(., digits = 1, format = "f"),
      row == 10 ~ formatC(., digits = 1, format = "f"),
      row == 11 ~ formatC(., format = "f", digits = 2),
      row == 12 ~ formatC(., format = "f", digits = 2),
      row == 13 ~ formatC(., digits = 1, format = "f"),
      row == 14 ~ formatC(., digits = 0, format = "f"),
      row == 15 ~ formatC(., digits = 0, format = "f"),
      TRUE ~ as.character(.)
    ),
    .names = "{.col}"
  )) |>
  ungroup() |>
  dplyr::select(-row) # remove helper column

#######################################################
# Create flextable
Location_table_ft <- flextable(f_complete_table_by_Sample_id) |>
  set_table_properties(layout = "autofit") |>
  line_spacing(space = 1.2) |>
  align(align = "center", part = "all") |>
   flextable::compose(
    j = "Measurement",
    i = complete_table_by_Sample_id$Measurement == "Other Bacteria",
    value = as_paragraph(as_chunk("Other\nBacteria"))
  )

# Merge cells for the 'Measurement' column based on values
Location_table_ft <- Location_table_ft |>
  merge_at(i = 1:5, j = 1, part = "body") |>
  merge_at(i = 6:10, j = 1, part = "body") |>
  merge_at(i = 11:15, j = 1, part = "body") |>
  hline(i = c(5, 10), border = fp_border(width = 1), part = "body")

# View the flextable
Location_table_ft

save_as_docx(Location_table_ft, path = "Location_table_ft.docx")
```
### Comparing stack bar plots
``` {R fig.width=7.5, fig.height=2.5, message = FALSE}
### Stacked bar plots for cyanobacteria
clades <- read_csv("clades.csv")
clade_vector <- c("Tolypothrix", "Nostoc", "Scytonema", "Chroococcidiopsis", "C-P", 
                  "Coleofasiculus", "Allocoleopsis", "Pleurocapsa", "Microcoleus", "Schizothrix", "Unidentified")


clade_color_table <- c("#59522C", "#60582D","#6E6532", "#6B892E", "#37a162", "#4AB649", "#56BC54", "#90DA8A", "#8ecc88", "#BFF2B7", "grey")

clade_color_map <- setNames(clade_color_table, clade_vector)

clade_labels <- vector("list", length(clade_vector))

# Italicize positions 1:4 and 6:10
clade_labels[1:4]  <- lapply(clade_vector[1:4],  function(x) bquote(italic(.(x))))
clade_labels[6:10] <- lapply(clade_vector[6:10], function(x) bquote(italic(.(x))))

# Keep the rest as plain text
clade_labels[5]  <- clade_vector[5]   # "C-P"
clade_labels[11] <- clade_vector[11]  # "Unidentified"

###########  Biocrust ################
BR_reads_init <- Genus_cyano_reads |>
  filter(str_detect(Sample_id, "init")) |>
  mutate(Sample_id = gsub("init", "", Sample_id)) |>
  mutate(Group = case_when(
    str_detect(Sample_id, "M1G|M2D|M3D") ~ "SF",  # Group rows with M1, M2, or M3 as "Solar Farm"
    TRUE ~ Sample_id  # Retain the original Sample_id for others
  )) %>%
  group_by(Group) %>%  # Group by the new column
  summarise(across(where(is.numeric), mean, na.rm = TRUE), 
  .groups = "drop") |>
  rename(Sample_id = Group) |>
  mutate(Group = case_when(
    str_detect(Sample_id, "LV1|LV2|LV3") ~ "LV",  # Group rows with M1, M2, or M3 as "Solar Farm"
    TRUE ~ Sample_id  # Retain the original Sample_id for others
  )) %>%
  group_by(Group) %>%  # Group by the new column
  summarise(across(where(is.numeric), mean, na.rm = TRUE), 
  .groups = "drop") |>
  mutate(Group = gsub("E2500", "25", Group)) |>
  mutate(Group = gsub("E3100", "31", Group))
  
init_index <- c("SF", "DG", "LV", "DD", "ND", "LC", "25", "31")
#init_index_no_SF <- c("DG", "LV", "DD", "ND", "LC", "25", "31")
BR_reads_init$Group <- factor(BR_reads_init$Group, levels = init_index)
  
long_format_BR_init <- pivot_longer(BR_reads_init, 
                            cols = -Group, 
                            names_to = "Taxa", 
                            values_to = "Reads")

ordered_BR_init <- long_format_BR_init |>
  arrange(Group, Taxa) |>
  na.omit() 
######## Subcrust  ###########
BR_reads_UC <- Genus_cyano_reads |>
  filter(str_detect(Sample_id, "UC")) |>
  mutate(Sample_id = gsub("UC", "", Sample_id)) |>
  mutate(Group = case_when(
    str_detect(Sample_id, "M1G|M2D|M3D") ~ "SF",  # Group rows with M1, M2, or M3 as "Solar Farm"
    TRUE ~ Sample_id  # Retain the original Sample_id for others
  )) %>%
  group_by(Group) %>%  # Group by the new column
  summarise(across(where(is.numeric), mean, na.rm = TRUE), 
  .groups = "drop") |>
  rename(Sample_id = Group) |>
  mutate(Group = case_when(
    str_detect(Sample_id, "LV1|LV2|LV3") ~ "LV",  # Group rows with M1, M2, or M3 as "Solar Farm"
    TRUE ~ Sample_id  # Retain the original Sample_id for others
  )) %>%
  group_by(Group) %>%  # Group by the new column
  summarise(across(where(is.numeric), mean, na.rm = TRUE), 
  .groups = "drop") |>
  mutate(Group = gsub("E2500", "25", Group)) |>
  mutate(Group = gsub("E3100", "31", Group))
  
BR_reads_UC$Group <- factor(BR_reads_UC$Group, levels = init_index)
  
long_format_BR_UC <- pivot_longer(BR_reads_UC, 
                            cols = -Group, 
                            names_to = "Taxa", 
                            values_to = "Reads")

ordered_BR_UC <- long_format_BR_UC |>
  arrange(Group, Taxa) |>
  na.omit() 

###Ordered BR subcrust here
ordered_BR_init_a <- ordered_BR_init |>
  mutate(location = "Biocrust")
ordered_BR_subcrust_a <- ordered_BR_UC |>
  mutate(location = "Undercrust")

ordered_BR_init_subr <- ordered_BR_init_a |>
  bind_rows(ordered_BR_subcrust_a) |>
  left_join(clades, by = "Taxa") |>  # Join based on the Taxa column
  dplyr::select(-Taxa) |>
  rename(Taxa = clade) |>
  group_by(Taxa, Group, location) |>
  summarise(Reads = sum(Reads), .groups = "drop") |>
  mutate(Taxa = factor(Taxa, levels = clade_vector)) 

# Ensure Group is a factor with the correct level order
ordered_BR_init_subr$Group <- factor(
  ordered_BR_init_subr$Group,
  levels = c("SF", "DG", "LV",
             "DD", "ND", "LC",
             "25", "31")
) 

cyanos_init_subr_plot <- ggplot(ordered_BR_init_subr, aes(x = location, y = Reads, fill = Taxa)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "", y = "", fill = "Genus (cyanobacteria)") +
  scale_fill_manual(values = clade_color_map, labels = clade_labels) + 
  theme_minimal() + 
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank(),
    axis.line = element_line(colour = "white"),
    axis.text.x = element_text(angle = 45, hjust = 1),  # x-axis text labels
    axis.ticks.x = element_blank(), # Remove x-axis ticks
    strip.text.x = element_blank(), # Remove facet labels
    panel.spacing.x = unit(2, "mm"),
    legend.position = "left",
    legend.text = element_text(size = 9),       # Make legend text smaller
        legend.title = element_text(size = 10),      # Make legend title smaller
        legend.key.size = unit(4, "mm")) +
  facet_grid(~Group, space = "free", scales = "free_x", switch = "x")

ggsave("cyano_clades.png", plot = cyanos_init_subr_plot, width = 7.5, height = 2.7, dpi = 300)

####################################################################################################
# Stacked bars for bacteria (no cyanos)
ASV_reads_bacteria_no_cyanos_w_taxon <- ASV_reads_all_bacteria |>
  filter(!str_detect(taxon, "Cyano"))

ASV_reads_bacteria_no_cyanos <- ASV_reads_all_bacteria |>
  filter(!str_detect(taxon, "Cyano")) |>
  dplyr::select(!taxon)

ASV_reads_bacteria_no_cyanos1 <- column_to_rownames(ASV_reads_bacteria_no_cyanos_w_taxon, var = "OTUID")

bac_no_cyanos_init <- ASV_reads_bacteria_no_cyanos1 |>
  dplyr::select(taxon, contains("init")) |>
  mutate(LVinit = rowMeans(across(c(LV1init, LV2init, LV3init)), na.rm = TRUE)) |>
  dplyr::select(-LV1init, -LV2init, -LV3init) |>
  mutate(SFinit = rowMeans(across(c(M1Ginit, M2Dinit, M3Dinit)), na.rm = TRUE)) |>
  dplyr::select(-M1Ginit, -M2Dinit, -M3Dinit) |>
  rename_with(~ gsub("init", "", .)) |>
  pivot_longer(cols = -taxon,
               names_to = "Location", 
               values_to = "Reads") |>
  mutate(location = "init") |>
  mutate(Location = ifelse(Location == "E2500", "25", Location)) |>
  mutate(Location = ifelse(Location == "E3100", "31", Location)) 

bac_no_cyanos_UC <- ASV_reads_bacteria_no_cyanos1 |>
  dplyr::select(taxon, contains("UC")) |>
  mutate(LVUC = rowMeans(across(c(LV1UC, LV2UC, LV3UC)), na.rm = TRUE)) |>
  dplyr::select(-LV1UC, -LV2UC, -LV3UC) |>
  mutate(SFUC = rowMeans(across(c(M1GUC, M2DUC, M3DUC)), na.rm = TRUE)) |>
  dplyr::select(-M1GUC, -M2DUC, -M3DUC) |>
  rename_with(~ gsub("UC", "", .)) |>
  pivot_longer(cols = -taxon,
               names_to = "Location", 
               values_to = "Reads") |>
  mutate(location = "UC") |>
  mutate(Location = ifelse(Location == "E2500", "25", Location)) |>
  mutate(Location = ifelse(Location == "E3100", "31", Location))

bacteria_no_cyanos_init_subr <- bac_no_cyanos_init |>
  bind_rows(bac_no_cyanos_UC) |>
  rename("Group" = "Location") |>
  mutate(order = ifelse(str_detect(taxon, "o__[^;]+"), 
                        str_extract(taxon, "o__[^;]+"), 
                        "o__unknown")) |>
  mutate(family = ifelse(str_detect(taxon, "f__[^;]+"), 
                        str_extract(taxon, "f__[^;]+"), 
                        "f__unknown")) |>
  mutate(phylum = ifelse(str_detect(taxon, "p__[^;]+"), 
                        str_extract(taxon, "p__[^;]+"), 
                        "p__unknown")) |>
  mutate(phylum = str_replace_all(phylum, "p__|\\[|\\]", "")) |>
  group_by(phylum, Group, location) |> 
  summarise(Reads = sum(Reads, na.rm = TRUE), .groups = "drop") |>
  group_by(phylum) |> 
  filter(sum(Reads) >= 2000) |> 
  ungroup() |>
  filter(phylum != "Cyanobacteria") |>
  filter(phylum != "FBP") |>
  mutate(Group = factor(Group, levels = init_index)) 

bacteria_no_cyanos_init_subr_plot <- ggplot(bacteria_no_cyanos_init_subr, aes(x = location, y = Reads, fill = phylum)) +
  geom_bar(stat = "identity", position = "fill") +
  labs(x = "", y = "", fill = "Phylum (other bacteria)") +
  theme_minimal() + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        panel.background = element_blank(), axis.line = element_line(colour = "white")) +
  facet_grid(~Group, space = "free", scales = "free_x") +
  theme(strip.text = element_text(size = 10),
        panel.spacing.x = unit(2, "mm"),
        axis.text.x = element_blank(),
        legend.position = "left",
        legend.text = element_text(size = 9),       # Make legend text smaller
        legend.title = element_text(size = 10),      # Make legend title smaller
        legend.key.size = unit(4, "mm"))            # Make legend symbols smaller 

ggsave("bacteria_phyla.png", plot = bacteria_no_cyanos_init_subr_plot, width = 7.5, height = 2.5, dpi = 300)
cyanos_init_subr_plot
bacteria_no_cyanos_init_subr_plot
```
## Volcano plots

``` {R fig.width=8, fig.height=6}
taxonomy_with_cyanos_identified <- taxonomy_all_bacteria %>%
  left_join(identified_cyanos) |>
  mutate(taxon = ifelse(!is.na(Genus), Genus, taxon)) |>
  dplyr::select(-Genus) |>
  filter(!grepl("Chloroplast", taxon)) |>
  filter(!grepl("Archaea", taxon)) |>
  filter(!grepl("ML635J", taxon)) |> ## eliminate a few more rogue chloroplasts
  filter(!grepl("4C0d-2", taxon)) ## eliminate a few more rogue chloroplasts
taxonomy_with_cyanos_identified <- as.data.frame(taxonomy_with_cyanos_identified)
rownames(taxonomy_with_cyanos_identified) <- taxonomy_with_cyanos_identified$OTUID

Reads_for_volcano <- ASV_reads_all_bacteria |>
  dplyr::select(-matches("12|re")) 

June_cytophag <- ASV_reads_all_bacteria |>
  dplyr::select(OTUID, matches("12"), taxon) |>
  filter(grepl("Cytophag", taxon))

April_cytophag <- Reads_for_volcano |>
  dplyr::select(OTUID, matches("YR1"), taxon) |>
  filter(grepl("Cytophag", taxon)) |>
  dplyr::select(-matches("M|00"))

cytophag <- left_join(April_cytophag, June_cytophag) |>
  mutate(DD = DDYR12 - DDYR1) |>
  mutate(DG = DGYR12 - DGYR1) |>
  mutate(LC = LCYR12 - LCYR1) |>
  mutate(LV = LVYR12 - LVYR1) |>
  mutate(ND = NDYR12 - NDYR1) 
############ Summarize replicates ##############
### LV replicates ## 
LV_replicate_groups <- list(
  LVUC = c("LV1UC", "LV2UC", "LV3UC"),
  LVinit = c("LV1init", "LV2init", "LV3init")
)

Reads_for_volcano1 <- Reads_for_volcano
for (new_col in names(LV_replicate_groups)) {
  Reads_for_volcano1 <- Reads_for_volcano1 %>%
    mutate(!!new_col := rowMeans(dplyr::select(., all_of(LV_replicate_groups[[new_col]]))))
}

# Step 3: Remove the original replicate columns (optional)
Reads_for_volcano1 <- Reads_for_volcano1 %>%
  dplyr::select(-unlist(LV_replicate_groups)) 

### M replicates. ###
M_replicate_groups <- list(
  MUC = c("M1GUC", "M2DUC", "M3DUC"),
  Minit = c("M1Ginit", "M2Dinit", "M3Dinit"),
  MYR1 = c("M1GYR1", "M2DYR1", "M3DYR1")
)

Reads_for_volcano2 <- Reads_for_volcano1

for (new_col in names(M_replicate_groups)) {
  Reads_for_volcano2 <- Reads_for_volcano2 %>%
    mutate(!!new_col := rowMeans(dplyr::select(., all_of(M_replicate_groups[[new_col]]))))
}

# Step 3: Remove the original replicate columns (optional)
Reads_for_volcano2 <- Reads_for_volcano2 %>%
  dplyr::select(-unlist(M_replicate_groups)) 

colnames(Reads_for_volcano2) <- gsub("E", "", colnames(Reads_for_volcano2))
colnames(Reads_for_volcano2) <- gsub("init", "i", colnames(Reads_for_volcano2))
colnames(Reads_for_volcano2) <- gsub("UC", "u", colnames(Reads_for_volcano2))
colnames(Reads_for_volcano2) <- gsub("YR1", "A", colnames(Reads_for_volcano2))
colnames(Reads_for_volcano2) <- gsub("2500", "25", colnames(Reads_for_volcano2))
colnames(Reads_for_volcano2) <- gsub("3100", "31", colnames(Reads_for_volcano2))

######################################

gene_counts <- qPCR |>
  filter(!str_detect(Sample_id, "J"))|>
  mutate(Sample_id = str_remove(Sample_id, "\\d+$")) |> ##removes number at end of string
  mutate(Sample_id = str_remove(Sample_id, "(_YR|c)$")) |>
  mutate(Sample_id = str_remove(Sample_id, "esa")) |>
  mutate(Sample_id = ifelse(str_detect(Sample_id, "M"), "M", Sample_id)) |>
  mutate(Sample_id = ifelse(Sample_id == "M",
                            paste0("M", case_when(
                              Type == "init" ~ "i",
                              Type == "UC" ~ "u",
                              Type == "April" ~ "A",
                              TRUE ~ ""  # leave as "M" if no match
                            )),
                            Sample_id)) |>
  group_by(Sample_id, Type) |>
  summarise(mean_counts = mean(genes_per_mgSoil, na.rm = TRUE)) 

# Transpose and ensure that row names stay intact
gene_counts_t <- as.data.frame(t(gene_counts$mean_counts))  # Transpose the summary data
colnames(gene_counts_t) <- gene_counts$Sample_id  # Set column names to be the 'S_id' values

scaled_OTU_table <- Reads_for_volcano2 |> 
  dplyr::select(-taxon)|>
  column_to_rownames(var = "OTUID")

scaled_OTU_table_integers <- scaled_OTU_table %>%
  mutate(across(everything(), ~ pmax(0, as.integer(round(.)))))

#########################

## Condense taxa to those uniquely identified. 
scaled_OTU_table_with_taxon <- scaled_OTU_table_integers %>%
  rownames_to_column("OTUID") %>%
  left_join(taxonomy_with_cyanos_identified, by = "OTUID") %>%
  column_to_rownames("OTUID")
  
summarized_otu_table <- scaled_OTU_table_with_taxon %>%
  group_by(taxon) %>%
  summarise(across(everything(), sum)) %>%
  ungroup() |>
   mutate(
    # Extract the highest non-empty taxonomic level
    taxa = str_extract_all(taxon, "[^;]+") %>%              # Split by semicolons
           sapply(function(x) {
             non_empty <- x[x != "" & !str_detect(x, "__$")] # Remove empty and incomplete levels
             if (length(non_empty) > 0) {
               last_taxa <- tail(non_empty, 1)              # Get the last valid level
               str_remove(last_taxa, "^.*__")              # Remove prefixes
             } else {
               NA                                           # Assign NA if all levels are empty
             }
           })
  ) |>
  dplyr::select(-taxon) |>
  mutate(taxa = gsub("\\[|\\]", "", taxa)) |>
  group_by(taxa) %>%
  summarise(across(everything(), sum)) %>%
  ungroup() 

# Make a copy of your table (assuming it's a data frame)
otu_table_filtered <- summarized_otu_table

# Identify all "u" time point columns (columns ending in 'u')
u_columns <- grep("u$", colnames(otu_table_filtered), value = TRUE)

# Calculate row sums for the "u" columns
u_sums <- rowSums(otu_table_filtered[, u_columns])

# Keep only the rows where the sum is greater than 0
otu_table_filtered <- otu_table_filtered[u_sums > 0, ]

summarized_otu_table <- summarized_otu_table %>%
  column_to_rownames("taxa")

summarized_otu_table_filtered <- otu_table_filtered %>%
  column_to_rownames("taxa") 
  

#######################################
## Compare Crust versus subcrust #######
Crust_vs_UC <- summarized_otu_table_filtered |>
  rename_with(~ str_replace(., "LIC", "LC"), contains("LC")) |>
  dplyr::select(-contains("A")) 

Crust_vs_UC <- Crust_vs_UC[, order(names(Crust_vs_UC))]

Crust_UC_groups <- factor(c("i", "u", "i", "u", "i", "u", "i", "u", "i", "u", "i", "u", "i", "u", "i", "u"))

# Create DGEList object
Crust_UC_dge <- DGEList(counts = Crust_vs_UC, group = Crust_UC_groups)

# Normalize the data
Crust_UC_dge <- calcNormFactors(Crust_UC_dge)

# Estimate the dispersion
Crust_UC_dge <- estimateDisp(Crust_UC_dge)

# Perform the differential abundance test
Crust_UC_test <- exactTest(Crust_UC_dge)

# Extract results
Crust_UC_results <- topTags(Crust_UC_test, n = Inf)$table  # Contains logFC and p-value
Crust_UC_results$logP <- -log10(Crust_UC_results$PValue)


# Add significance column
Crust_UC_results_sig <- Crust_UC_results %>%
  mutate(Significant = case_when(
  PValue < 0.0005 ~ "Yes",
  TRUE ~ "No"
)) |>
   rownames_to_column(var = "taxa") |>
  mutate(
    # Extract the highest non-empty taxonomic level
    taxa = str_extract_all(taxa, "[^;]+") %>%              # Split by semicolons
           sapply(function(x) {
             non_empty <- x[x != "" & !str_detect(x, "__$")] # Remove empty and incomplete levels
             if (length(non_empty) > 0) {
               last_taxa <- tail(non_empty, 1)              # Get the last valid level
               str_remove(last_taxa, "^.*__")              # Remove prefixes
             } else {
               NA                                           # Assign NA if all levels are empty
             }
           })
  )

# Create the volcano plot
Crust_UC_plot <- ggplot(Crust_UC_results_sig, aes(x = -logFC, y = logCPM, color = Significant)) +
  geom_point(size = 1.5, alpha = 0.5) +
  scale_color_manual(values = c("No" = "gray", "Yes" = "green")) +
  labs(x = "Log Fold Change", y = "average normalized gene counts", title = "Undercrusts versus biocrusts") +
  #scale_y_continuous(limits = c(0, 11)) +
  theme_minimal() +
  theme(
  axis.title.x = element_text(size = 8),
  axis.title.y = element_text(size = 8),
  plot.title = element_text(size = 10)
) +
  theme(legend.position = "none") +
  geom_text_repel(
    data = Crust_UC_results_sig %>% filter(Significant == "Yes"),
    aes(label = taxa),
    color = "black",          # Set label color to black
    size = 2,
    max.overlaps = Inf
  )

Crust_UC_plot 
ggsave("Crust_subcrust_volcano.png", plot = Crust_UC_plot, width = 7, height = 4, dpi = 300)

###########################################
##### Compare subcrust versus recovering biocrust #######
recov_Crust_vs_UC <- summarized_otu_table_filtered |>
  rename_with(~ str_replace(., "LIC", "LC"), contains("LIC")) |>
  dplyr::select(-contains("i")) 

recov_Crust_vs_UC <- recov_Crust_vs_UC[, order(names(recov_Crust_vs_UC))]

recov_Crust_UC_groups <- factor(c("A", "u", "A", "u", "A", "u", "A", "u", "A", "u", "A", "u", "A", "u", "A", "u"))

# Create DGEList object
recov_Crust_UC_dge <- DGEList(counts = recov_Crust_vs_UC, group = recov_Crust_UC_groups)

# Normalize the data
recov_Crust_UC_dge <- calcNormFactors(recov_Crust_UC_dge)

# Estimate the dispersion
recov_Crust_UC_dge <- estimateDisp(recov_Crust_UC_dge)

# Perform the differential abundance test
recov_Crust_UC_test <- exactTest(recov_Crust_UC_dge)
#recov_Crust_UC_test$table

# Extract results
recov_Crust_UC_results <- topTags(recov_Crust_UC_test, n = Inf)$table |>
  mutate(logFC = -1*logFC) # Contains logFC and p-value
recov_Crust_UC_results$logP <- -log10(recov_Crust_UC_results$PValue)


# Add significance column
recov_Crust_UC_results_sig <- recov_Crust_UC_results %>%
  mutate(Significant = case_when(
  PValue < 0.01 ~ "Yes",
  TRUE ~ "No"
)) |>
   rownames_to_column(var = "taxa") |>
  mutate(
    # Extract the highest non-empty taxonomic level
    taxa = str_extract_all(taxa, "[^;]+") %>%              # Split by semicolons
           sapply(function(x) {
             non_empty <- x[x != "" & !str_detect(x, "__$")] # Remove empty and incomplete levels
             if (length(non_empty) > 0) {
               last_taxa <- tail(non_empty, 1)              # Get the last valid level
               str_remove(last_taxa, "^.*__")              # Remove prefixes
             } else {
               NA                                           # Assign NA if all levels are empty
             }
           })
  )

# Create the volcano plot
recov_Crust_UC_plot <- ggplot(recov_Crust_UC_results_sig, aes(x = logFC, y = logCPM, color = Significant)) +
  geom_point(size = 1.5, alpha = 0.5) +
  scale_color_manual(values = c("No" = "gray", "Yes" = "darkgreen")) +
  labs(x = "Log Fold Change", y = "average normalized gene counts", title = "Undercrusts versus recovering biocrusts") +
  #scale_y_continuous(limits = c(0, 11)) +
  theme_minimal() +
  theme(
  axis.title.x = element_text(size = 8),
  axis.title.y = element_text(size = 8),
  plot.title = element_text(size = 10)
) +
  theme(legend.position = "none") +
  geom_text_repel(
    data = recov_Crust_UC_results_sig %>% filter(Significant == "Yes"),
    aes(label = taxa),
    color = "black",          # Set label color to black
    size = 2,
    max.overlaps = Inf
  )

recov_Crust_UC_plot 
ggsave("Recovering_biocrust_subcrust_volcano.png", plot = recov_Crust_UC_plot, width = 7, height = 4, dpi = 300)
```
## Flextable to accompany Volcano plots
```{R}
#### Calculate # 16S cyano genes in uc soil
qPCR_UC <- read_excel("qPCR_biocrust recovery_summary_part2.xlsx", 
    sheet = "Results Summary", 
    range = "B11:I102", col_types = c("text", "numeric", "numeric", "numeric", "numeric","numeric", "numeric", "numeric")) |>
  rename("Sample_id" = 1, "genes_per_mgSoil" = 8) |>
  dplyr::select(1, 8) |>
  filter(str_detect(Sample_id, "uc")) |>
  filter(str_detect(Sample_id, "ND|LV")) |>
  mutate(Sample_id = substr(Sample_id, 1, 2)) |>
  group_by(Sample_id) |>
  summarise(across(everything(), mean, na.rm = TRUE))

qPCR_biocrust <- read_excel("qPCR_biocrust recovery_summary_part2.xlsx", 
    sheet = "Results Summary", 
    range = "B11:I102", col_types = c("text", "numeric", "numeric", "numeric", "numeric","numeric", "numeric", "numeric")) |>
  rename("Sample_id" = 1, "genes_per_mgSoil" = 8) |>
  dplyr::select(1, 8) |>
  filter(str_detect(Sample_id, "i")) |>
  filter(str_detect(Sample_id, "ND|LV")) |>
  mutate(Sample_id = substr(Sample_id, 1, 2)) |>
  group_by(Sample_id) |>
  summarise(across(everything(), mean, na.rm = TRUE))

uc_pct_cyanos <- all_reads_summary_crust_sub |>
  filter(Type == "UC") |>
  filter(Sample_id %in% c("ND", "LV")) |>
  dplyr::select(!Type) |>
  dplyr::select(!bac_not_cyanos) |>
  mutate(pct_cyanos = all_cyanos / all_bac)

biocrust_pct_cyanos <- all_reads_summary_crust_sub |>
  filter(Type == "init") |>
  filter(Sample_id %in% c("ND", "LV")) |>
  dplyr::select(!Type) |>
  dplyr::select(!bac_not_cyanos) |>
  mutate(pct_cyanos = all_cyanos / all_bac)

UC_cyano_genes <- left_join(uc_pct_cyanos, qPCR_UC, by = "Sample_id") |>
  mutate(uc_cyano_genes_counts = (genes_per_mgSoil * pct_cyanos)) 

biocrust_cyano_genes <- left_join(biocrust_pct_cyanos, qPCR_biocrust, by = "Sample_id") |>
  mutate(biocrust_cyano_genes_counts = (genes_per_mgSoil * pct_cyanos))

UC_LV_cyano_genes <- UC_cyano_genes |>
  filter(Sample_id == "LV") |> 
  dplyr::select(uc_cyano_genes_counts) |>
  pull(1)

UC_ND_cyano_genes <- UC_cyano_genes |>
  filter(Sample_id == "ND") |> 
  dplyr::select(uc_cyano_genes_counts) |>
  pull(1)

biocrust_LV_cyano_genes <- biocrust_cyano_genes |>
  filter(Sample_id == "LV") |> 
  dplyr::select(biocrust_cyano_genes_counts) |>
  pull(1)

biocrust_ND_cyano_genes <- biocrust_cyano_genes |>
  filter(Sample_id == "ND") |> 
  dplyr::select(biocrust_cyano_genes_counts) |>
  pull(1)

## Cyanos by taxa for undercrust
uc_cyano_counts_by_taxa <- UC_cyanos |>
  filter(str_detect(Sample_id, "UC")) |>
  filter(str_detect(Sample_id, "ND|LV")) |>
  mutate(Sample_id = ifelse(Sample_id %in% c("LV1UC", "LV2UC", "LV3UC"), "LV", Sample_id)) |>
  group_by(Sample_id) |>
  summarise(across(everything(), mean, na.rm = TRUE)) |>
  pivot_longer(-Sample_id, names_to = "Taxon", values_to = "Count") |>
  pivot_wider(names_from = Sample_id, values_from = Count) |>
  mutate(LVUC_genes = LV / sum(LV) * UC_LV_cyano_genes) |>
  mutate(NDUC_genes = NDUC / sum(NDUC) * UC_ND_cyano_genes) |>
  mutate(UC_gene_counts = rowMeans(across(c(LVUC_genes, NDUC_genes)), na.rm = TRUE)) |>
  dplyr::select(Taxon, UC_gene_counts) |>
  mutate(across(where(is.numeric), ~ round(.,0)))

## Cyanos by taxa for biocrust
biocrust_cyano_counts_by_taxa <- biocrust_cyanos |>
  filter(str_detect(Sample_id, "init")) |>
  filter(str_detect(Sample_id, "ND|LV")) |>
  mutate(Sample_id = ifelse(Sample_id %in% c("LV1init", "LV2init", "LV3init"), "LV", Sample_id)) |>
  group_by(Sample_id) |>
  summarise(across(everything(), mean, na.rm = TRUE)) |>
  pivot_longer(-Sample_id, names_to = "Taxon", values_to = "Count") |>
  pivot_wider(names_from = Sample_id, values_from = Count) |>
  mutate(LVinit_genes = LV / sum(LV) * biocrust_LV_cyano_genes) |>
  mutate(NDinit_genes = NDinit / sum(NDinit) * biocrust_ND_cyano_genes) |>
  mutate(biocrust_gene_counts = rowMeans(across(c(LVinit_genes, NDinit_genes)), na.rm = TRUE)) |>
  dplyr::select(Taxon, biocrust_gene_counts) |>
  mutate(across(where(is.numeric), ~ round(.,0)))


#######

#### Calculate # 16S cyano genes in farm soil
vert_no_cyano_reads_table <- read_excel("vert_no-cyano_reads_table.xlsx", 
     sheet = "vert_no-cyano_reads_table", 
     range = "A1:J1889")

bac_reads_vert <- sum(vert_no_cyano_reads_table$`Vert-farm`)

cyano_vert_farm_reads <- read_excel("vert_cyano_table-w-taxonomy.xlsx", 
                    sheet = "cyano_table-w-taxonomy", 
                    range = "A1:M133", col_types = c("text", "numeric", "numeric", "numeric", "numeric","numeric", "numeric", "numeric", "numeric","numeric", "numeric", "numeric", "text")) |>
  dplyr::select(1,2,10,13) |>
  filter(!is.na(Taxon)) |>
  dplyr::select(c(-1)) |>
  group_by(Taxon) %>%  # Add reads with same taxa
  summarise(across(everything(), sum)) |>
  ungroup() |>
  rename("Vert_farm" = "Vert-farm") |>
  dplyr::select(-PF) 

cyano_reads_vert <- sum(cyano_vert_farm_reads$`Vert_farm`)
vert_pct_cyanos = cyano_reads_vert / (cyano_reads_vert + bac_reads_vert)

qPCR_farm_value <- read_excel(
  "16S_soil_qPCR_vertucio_farm1_complete.xlsx",
  sheet = "Calculation",
  range = "I24",
  col_types = "numeric",
  col_names = FALSE
) |> 
  pull(1)
  
vert_cyano_genes = vert_pct_cyanos * qPCR_farm_value

farm_cyano_counts_by_taxa <- cyano_vert_farm_reads |>
  mutate(farm_gene_numbers = Vert_farm / sum(Vert_farm) * vert_cyano_genes) |>
  mutate(across(where(is.numeric), ~ round(.,0))) |>
  dplyr::select(!Vert_farm)

### Prepare table for flaxtable ###
bc_uc_vert_counts <- biocrust_cyano_counts_by_taxa |>
  left_join(farm_cyano_counts_by_taxa, by = "Taxon") |>
  left_join(uc_cyano_counts_by_taxa, by = "Taxon") 
bc_uc_vert_counts[is.na(bc_uc_vert_counts)] <- 0

 bc_uc_vert_counts <- bc_uc_vert_counts |>
   filter(Taxon != "Crassifilum") |> ## no reads
   filter(Taxon != "Leptolyngbya") |>
   filter(Taxon != "Pleurocapsa")
 
 bc_uc_vert_counts <- bc_uc_vert_counts |>
  dplyr::select(
    Genus = Taxon,
    Biocrust = biocrust_gene_counts,
    Undercrust = UC_gene_counts,
    Farm = farm_gene_numbers
  ) %>%
   bind_rows(
    summarise(., across(where(is.numeric), sum), Genus = "Total")
  ) %>%
  mutate(
    across(where(is.numeric), ~if_else(Genus == "Total", comma(.), as.character(.)))
  )
 
 # Create a flextable
bc_uc_farm_ft <- flextable(bc_uc_vert_counts) 
#bc_uc_farm_ft <- hline(bc_uc_farm_ft, i = 11, border = fp_border(width = 2, color = "black"))
bc_uc_farm_ft <- align(bc_uc_farm_ft, align = "center", part = "all")
bc_uc_farm_ft <- color(bc_uc_farm_ft, color = "black", part = "header") |>
  autofit()

bc_uc_farm_ft

save_as_docx(bc_uc_farm_ft, path = "bc_uc_farm_ft.docx")
 
############# 
 biocrust_uv_sig_taxa <- Crust_UC_results_sig |>
  filter(Significant == "Yes") |>
  dplyr::select(taxa)

recov_uv_sig_taxa <- recov_Crust_UC_results_sig |>
  filter(Significant == "Yes") |>
  dplyr::select(taxa)

volcano_sig <- inner_join(biocrust_uv_sig_taxa, recov_uv_sig_taxa, by = "taxa") |>
  rename("Taxon" = "taxa")

  #significant_cyanos <- inner_join(volcano_sig, vert_uc_counts, by = "Taxon") |>
  #mutate(across(where(is.numeric), ~ round(.,1)))

###############
## Prepare for flextable ##
#uc_farm_cyano_genes <- significant_cyanos |>
  #rename("Taxa" = "Taxon") |>
  #rename("Farm" = "farm_gene_numbers") |>
 # rename("Undercrusts" = "UC_gene_counts") 

#uc_farm_cyano_genes_with_summary <- uc_farm_cyano_genes |>
 #   dplyr::bind_rows(
 #   dplyr::summarise(
  #    uc_farm_cyano_genes,
  #    across(where(is.numeric), sum, na.rm = TRUE)
 #   ) |>
  #    dplyr::mutate(Taxa = "Total")
 # ) |>
  # Add Farm/Subcrusts ratio to the Total row
  #dplyr::mutate(farm_pct = dplyr::case_when(
  #  Taxa == "Total" ~ Farm / Undercrusts * 100,
  #  TRUE ~ farm_pct
  #)) |>
  #dplyr::select(1,3,2,4) |>
 # rename("Farm/Undercrust (%)" = "farm_pct") |>
 # mutate(across(where(is.numeric), ~ round(.,1)))

######################################################
## In farm soil not in UC
#Vert_farm_reads <- vert_no_cyano_reads_table |>
  #dplyr::select(1,10)

# LV_UC_bac_reads <-ASV_reads_all_bacteria |>
#   dplyr::select("OTUID", taxon, LV1UC, LV2UC, LV3UC) |>
#   mutate(LVUC = rowMeans(across(c(LV1UC, LV2UC, LV3UC)), na.rm = TRUE)) |>
#   dplyr::select(1,2,6)
# 
# ND_UC_bac_reads <-ASV_reads_all_bacteria |>
#   dplyr::select("OTUID", NDUC)
# 
# UC_bac_reads <- left_join(LV_UC_bac_reads, ND_UC_bac_reads) |>
#   dplyr::select(2:4)
# 
# vert_taxonomy <- read.delim("~/ASU Dropbox/Brian Scott/ASU/R/Biocrust Recovery/vert_taxonomy.tsv") |>
#   dplyr::select(1,2) |>
#   rename("OTUID" = "Feature.ID")
# vert_farm_reads1 <- Vert_farm_reads |>
#   rename("OTUID" = "#OTU ID") |>
#   left_join(vert_taxonomy) |>
#   rename("taxon" = "Taxon") |>
#   dplyr::select(3,2)
# 
# UC_farm_bac_reads <- left_join(UC_bac_reads, vert_farm_reads1) |>
#   filter(`Vert-farm` != 0, LVUC == 0, NDUC == 0) |>
#   distinct() |>
#   group_by(taxon) %>%
#   summarise(`Vert-farm` = sum(`Vert-farm`, na.rm = TRUE), .groups = "drop") |>
#   mutate(
#     # Extract the highest non-empty taxonomic level
#     taxon = str_extract_all(taxon, "[^;]+") %>%              # Split by semicolons
#            sapply(function(x) {
#              non_empty <- x[x != "" & !str_detect(x, "__$")] # Remove empty and incomplete levels
#              if (length(non_empty) > 0) {
#                last_taxa <- tail(non_empty, 1)              # Get the last valid level
#                str_remove(last_taxa, "^.*__")              # Remove prefixes
#              } else {
#                NA                                           # Assign NA if all levels are empty
#              }
#            })
#   )|>
#   rename("taxa" = "taxon")
# 
# taxa_sig <- bind_rows(
#   Crust_UC_results_sig %>%
#     filter(Significant == "Yes") %>%
#     dplyr::select(taxa),
#   recov_Crust_UC_results_sig %>%
#     filter(Significant == "Yes") %>%
#     dplyr::select(taxa)
# ) %>%
#   distinct()
# 
# common_taxa_table <- UC_farm_bac_reads %>%
#   semi_join(taxa_sig, by = "taxa") |>
#   distinct()
```
## Inoculated versus unioculated - table
```{R}
##########################
## Test for effect of re-inoculation
Chl_reinoc_effect <- Chl |>
  filter(type %in% c("Crust", "YR1", "re-inoc")) |>
  mutate(Sample_id = gsub("\\(g\\)", "", Sample_id)) %>%
  mutate(Sample_id = gsub("\\(d\\)", "", Sample_id)) |>
  mutate(Sample_id = gsub("-[1-3]$", "", Sample_id)) |>
  mutate(Sample_id = gsub("recov", "", Sample_id)) |>
  mutate(Sample_id = gsub("3100", "E31", Sample_id)) |>
  mutate(Sample_id = gsub("2500", "E25", Sample_id)) |>
  mutate(Sample_id = gsub("M1|M2|M3", "Mesa", Sample_id)) |>
  mutate(Sample_id = gsub("-re", "", Sample_id)) |>
  mutate(Sample_id = gsub("_reinoc", "", Sample_id)) |>
  mutate(Sample_id = gsub("g|d", "", Sample_id)) |>
  mutate(Sample_id = gsub("-inoc", "", Sample_id)) |>
  mutate(Sample_id = gsub("Mesa1|Mesa2|Mesa3", "Mesa", Sample_id)) |>
  group_by(Sample_id, month, type) |>
  summarise(
    mean_μgChl_m2 = mean(μgChl_m2, na.rm = TRUE),
    .groups = 'drop'
  ) |>
  mutate(Sample_id = factor(Sample_id, levels = c("Mesa", "DG", "LV", "DD", "ND", "Lic", "E25", "E31"))) |>
  mutate(type = factor(type, levels = c("Crust", "YR1", "re-inoc"))) |>
  mutate(month = factor(month, levels = c("December", "May", "June"))) |>
   group_by(Sample_id) %>%
  # Add adj_mean_chl column with the updated formula
  mutate(adj_mean_chl = if_else(
    type == "re-inoc" & any(type == "Crust"),
    mean_μgChl_m2 - 0.05 * mean_μgChl_m2[type == "Crust"][1],
    mean_μgChl_m2 # Carry over mean_μgChl_m2 when no calculation is made
  )) %>%
  ungroup() |>
  filter(type != "Crust") |>
  dplyr::select(!"mean_μgChl_m2")

# Pivot the data to wide format
paired_chl_data <- Chl_reinoc_effect %>%
  filter(type %in% c("re-inoc", "YR1")) %>%
  pivot_wider(names_from = type, values_from = adj_mean_chl) %>%
  drop_na()  # Ensure no missing values

# Extract paired columns
Chl_re_inoc <- paired_chl_data$`re-inoc`
Chl_yr1 <- paired_chl_data$YR1

# Normality test (optional)
shapiro_re_inoc <- shapiro.test(Chl_re_inoc)
shapiro_yr1 <- shapiro.test(Chl_yr1)
normal_test <- shapiro_re_inoc$p.value > 0.05 && shapiro_yr1$p.value > 0.05
if (normal_test) {
  message("The data is normally distributed.")
} else {
  message("The data is not normally distributed.")
}

# Perform statistical test
Chl_wilcox_result <- wilcox.test(Chl_re_inoc, Chl_yr1, paired = TRUE, alternative = "greater")
print(Chl_wilcox_result)

if (Chl_wilcox_result$p.value < 0.05) {
  cat("The difference is statistically significant.\n")
} else {
  cat("The difference is not statistically significant.\n")
}###############
## Create flextable ##
recov_re_inoc_table <- paired_chl_data |>
  mutate(Sample_id = str_replace(Sample_id, "E", "")) |>
  mutate(Sample_id = str_replace(Sample_id, "Mesa", "SF")) |>
  mutate(Sample_id = str_replace(Sample_id, "Lic", "LC")) |>
  rename("Month" = "month") |>
  rename("Uninoculated" = "YR1") |>
  rename("Reinoculated" = "re-inoc") |>
  rename("Site" = "Sample_id") |>
  mutate(across(where(is.numeric), ~ round(., 2)))
  
# Create a flextable
recov_re_inoc_table_ft <- flextable(recov_re_inoc_table) 

recov_re_inoc_table_ft

save_as_docx(recov_re_inoc_table_ft, path = "Inoc_vs_uninoc.docx")
  
```
## Compare counted undercrust filaments to Chla
```{R message = FALSE}
##########################
Chl_g <- Chl |>
  dplyr::select(1:3, 5) |>
  filter(type %in% c("Crust", "UC", "YR1")) |>
  mutate(Sample_id = gsub("\\(g\\)", "", Sample_id)) %>%
  mutate(Sample_id = gsub("\\(d\\)", "", Sample_id)) |>
  mutate(rep = substr(Sample_id, nchar(Sample_id), nchar(Sample_id))) |>
  mutate(Sample_id = gsub("-[1-3]$", "", Sample_id)) |>
  mutate(Sample_id = gsub("uc|recov", "", Sample_id)) |>
  mutate(Sample_id = gsub("3100", "31", Sample_id)) |>
  mutate(Sample_id = gsub("2500", "25", Sample_id)) |>
  mutate(Sample_id = gsub("Mesa", "SF", Sample_id)) |>
  mutate(Sample_id = factor(Sample_id, levels = c("SF", "DG", "LV", "DD", "ND", "LC", "25", "31"))) |>
  filter(month == "May") |>
  arrange(type, Sample_id, μgChl_g) |>
  group_by(type, Sample_id) %>%       # Group by "type" and "Sample_id"
  mutate(index = row_number()) %>%    # Add an index column
  ungroup() %>%
  group_by(Sample_id) %>%
  summarise(mean_ugChl_g = mean(μgChl_g, na.rm = TRUE), .groups = "drop")

bundles <- read_excel("Bundles.xlsx", range = "A1:C8") |>
  dplyr::select(1, 3) |>
  rename("Sample_id" = 1, "bundles_cm2" = 2)

bundles_chla <- left_join(Chl_g, bundles, by = "Sample_id") |>
  filter(!is.na(mean_ugChl_g) & !is.na(bundles_cm2))

bund_chla_model <- lm(mean_ugChl_g ~ bundles_cm2, data = bundles_chla)
bund_chla_r_sq <- summary(bund_chla_model)$r.squared

bundle_plot <- ggplot(bundles_chla, aes(x = bundles_cm2, y = mean_ugChl_g)) +
  geom_point(size = 2) +
  geom_smooth(method = "lm", se = TRUE, color = "blue", alpha = 0.3) +
  theme_minimal() +
  labs(
    x = expression("Bundles cm"^{-2}),
    y = "Chla (µg/g)"
  ) +
  annotate("text",
           x = min(bundles_chla$bundles_cm2),
           y = max(bundles_chla$mean_ugChl_g),
           label = paste0("R² = ", round(bund_chla_r_sq, 2)),
           hjust = 0, size = 5) +
  theme(
    panel.background = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(color = "black")
  )

bundle_plot
ggsave("bundle_plot.png", plot = bundle_plot, width = 7, height = 4, dpi = 300)

bundle_plot_model <- lm(mean_ugChl_g ~ bundles_cm2, data = bundles_chla)
summary(bundle_plot_model)

############################################
## 16S linear model with bundles
bundle_cyano_16S <- complete_table_by_Sample_id |>
  filter(Measurement %in% c("Cyanobacteria"),
         Layer == "Recovering") |>
  dplyr::select(-Measurement, -Layer) |>
  pivot_longer(
    cols = where(is.numeric),         # All numeric columns
    names_to = "Sample_id",           # New column for original column names
    values_to = "cyano_16S"                 # New column for values
  ) |>
  left_join(bundles_chla ,by = "Sample_id") |>
  filter(!is.na(bundles_cm2))


bundle_16S_model <- lm(mean_ugChl_g ~ bundles_cm2, data = bundle_cyano_16S)
summary(bundle_16S_model)
```
## Diversity calculations
```{R message = FALSE}
##########################
#### Calculate diveristy of cyanobacteria
# Step 1: Get diversity estimates
cyano_alpha_div <- estimate_richness(physeq_cyanos, measures = c("Shannon", "Simpson", "Observed"))

# Step 2: Add metadata (e.g., SampleType)
cyano_metadata <- data.frame(sample_data(physeq_cyanos))
cyano_alpha_div$Type <- cyano_metadata$Type
cyano_alpha_div$Location <- cyano_metadata$Location

div_selected_locations <- c("DG", "LV", "DD", "ND", "LC")

# Step 3: Summarize by SampleType
cyano_alpha_summary <- cyano_alpha_div %>%
  filter(Location %in% div_selected_locations) %>% #filtered out locations that were not reinoculated
  group_by(Type) %>%
  summarise(
    n = n(),  # define n first!
    Shannon_mean = mean(Shannon, na.rm = TRUE),
    Shannon_se   = sd(Shannon, na.rm = TRUE) / sqrt(n),
    Simpson_mean = mean(Simpson, na.rm = TRUE),
    Simpson_se   = sd(Simpson, na.rm = TRUE) / sqrt(n),
    Richness_mean = mean(Observed, na.rm = TRUE),
    Richness_se   = sd(Observed, na.rm = TRUE) / sqrt(n),
    .groups = 'drop'
  )

# View result
#print(cyano_alpha_summary)

cyano_alpha_div_filtered <- cyano_alpha_div %>%
  filter(Location %in% div_selected_locations)

# Step 3: Run ANOVAs on filtered data
cyano_anova_shannon <- aov(Shannon ~ Type, data = cyano_alpha_div_filtered)
summary(cyano_anova_shannon)
cyano_anova_simpson <- aov(Simpson ~ Type, data = cyano_alpha_div_filtered)
summary(cyano_anova_simpson)
cyano_anova_rich <- aov(Observed ~ Type, data = cyano_alpha_div_filtered)
summary(cyano_anova_rich)

cyano_diversity_comparisons_shannon <- TukeyHSD(cyano_anova_shannon)
cyano_diversity_comparisons_simpson <- TukeyHSD(cyano_anova_simpson)
cyano_diversity_comparisons_rich <- TukeyHSD(cyano_anova_rich)

cyano_diversity_comparisons_shannon
cyano_diversity_comparisons_simpson
cyano_diversity_comparisons_rich

######################################
#### Calculate diveristy of other bacteria
# Step 1: Get diversity estimates
no_cyano_alpha_div <- estimate_richness(physeq_no_cyanos, measures = c("Shannon", "Simpson", "Observed"))

# Step 2: Add metadata (e.g., SampleType)
no_cyano_metadata <- data.frame(sample_data(physeq_no_cyanos))
no_cyano_alpha_div$Type <- no_cyano_metadata$Type
no_cyano_alpha_div$Location <- no_cyano_metadata$Location

# Step 3: Summarize by SampleType
no_cyano_alpha_summary <- no_cyano_alpha_div %>%
  filter(Location %in% div_selected_locations) %>% #filtered out locations that were not reinoculated
  group_by(Type) %>%
  summarise(
    n = n(),  # define n first!
    Shannon_mean = mean(Shannon, na.rm = TRUE),
    Shannon_se   = sd(Shannon, na.rm = TRUE) / sqrt(n),
    Simpson_mean = mean(Simpson, na.rm = TRUE),
    Simpson_se   = sd(Simpson, na.rm = TRUE) / sqrt(n),
    Richness_mean = mean(Observed, na.rm = TRUE),
    Richness_se   = sd(Observed, na.rm = TRUE) / sqrt(n),
    .groups = 'drop'
  )

# View result
print(no_cyano_alpha_summary)

no_cyano_alpha_div_filtered <- no_cyano_alpha_div %>%
  filter(Location %in% div_selected_locations)

# Step 3: Run ANOVAs on filtered data
no_cyano_anova_shannon <- aov(Shannon ~ Type, data = no_cyano_alpha_div_filtered)
summary(no_cyano_anova_shannon)
no_cyano_anova_simpson <- aov(Simpson ~ Type, data = no_cyano_alpha_div_filtered)
summary(no_cyano_anova_simpson)
no_cyano_anova_rich <- aov(Observed ~ Type, data = no_cyano_alpha_div_filtered)
summary(no_cyano_anova_rich)

no_cyano_diversity_comparisons_shannon <- TukeyHSD(no_cyano_anova_shannon)
# no_cyano_diversity_comparisons_simpson <- TukeyHSD(no_cyano_anova_simpson) ## ANOVA fail
# no_cyano_diversity_comparisons_rich <- TukeyHSD(no_cyano_anova_rich) ## ANOVA fail

no_cyano_diversity_comparisons_shannon

######################################
## Create flextables
cyano_Shannon_Table <- cyano_alpha_summary |>
  dplyr::select(1:4) |>
  mutate(across(where(is.numeric), ~ round(., 1))) |>
  mutate(Shannon_mean = format(Shannon_mean, nsmall = 1)) |>
  mutate('Cyanobacteria' = str_c(Shannon_mean, " ± ", Shannon_se)) |> 
  dplyr::select(1,2,'Cyanobacteria')

no_cyano_Shannon_Table <- no_cyano_alpha_summary |>
  dplyr::select(1:4) |>
  mutate(across(where(is.numeric), ~ round(., 2))) |>
  mutate(Shannon_mean = format(Shannon_mean, nsmall = 1)) |>
  mutate('Other bacteria' = str_c(Shannon_mean, " ± ", Shannon_se)) |> 
  dplyr::select(1,2,'Other bacteria') 

Combined_Shannon_Table <- left_join(cyano_Shannon_Table, no_cyano_Shannon_Table, by = "Type") |>
  dplyr::select(!4) |>
  rename("n" = 2) |>
  mutate(
    Type = case_when(
      Type == "initial" ~ "Biocrust",
      Type == "UC" ~ "Undercrust",
      Type == "YR1" ~ "Recovering",
      Type == "reinoculated" ~ "Reinoculated"
    ))


# Create a flextable
ft_Shannon <- flextable(Combined_Shannon_Table) |>
  add_header_row(
    values = "Shannon Diversity Index",
    colwidths = 4
  ) |>
  align(align = "center", part = "all") |>
  bold(i = 1:2, part = "header") |>  # Emphasize global result
  autofit()

ft_Shannon

save_as_docx(ft_Shannon, path = "ft_Shannon.docx")

```